# 1. å¹¶å‘é”ç®€ä»‹

## 1.1 ä¹è§‚é”ä¸æ‚²è§‚é”

ä¹è§‚é”ä¸æ‚²è§‚é”ä¸æ˜¯æŒ‡å…·ä½“çš„ä»€ä¹ˆç±»å‹çš„é”ï¼Œè€Œæ˜¯**å¤„ç†å¹¶å‘åŒæ­¥çš„ç­–ç•¥**ã€‚

- **ä¹è§‚é”** - ä¹è§‚é”å¯¹äºå¹¶å‘é‡‡å–ä¹è§‚çš„æ€åº¦ï¼Œè®¤ä¸ºï¼š**ä¸åŠ é”çš„å¹¶å‘æ“ä½œä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚å¯¹äºåŒä¸€ä¸ªæ•°æ®çš„å¹¶å‘æ“ä½œï¼Œæ˜¯ä¸ä¼šå‘ç”Ÿä¿®æ”¹çš„**ã€‚åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¼šé‡‡ç”¨ä¸æ–­å°è¯•æ›´æ–°çš„æ–¹å¼æ›´æ–°æ•°æ®ã€‚**ä¹è§‚é”é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯**ã€‚
- **æ‚²è§‚é”** - æ‚²è§‚é”å¯¹äºå¹¶å‘é‡‡å–æ‚²è§‚çš„æ€åº¦ï¼Œè®¤ä¸ºï¼š**ä¸åŠ é”çš„å¹¶å‘æ“ä½œä¸€å®šä¼šå‡ºé—®é¢˜**ã€‚**æ‚²è§‚é”é€‚åˆå†™æ“ä½œé¢‘ç¹çš„åœºæ™¯**ã€‚

æ‚²è§‚é”ä¸ä¹è§‚é”åœ¨ Java ä¸­çš„å…¸å‹å®ç°ï¼š

- æ‚²è§‚é”åœ¨ Java ä¸­çš„åº”ç”¨å°±æ˜¯é€šè¿‡ä½¿ç”¨ `synchronized` å’Œ `Lock` æ˜¾ç¤ºåŠ é”æ¥è¿›è¡Œäº’æ–¥åŒæ­¥ï¼Œè¿™æ˜¯ä¸€ç§é˜»å¡åŒæ­¥ã€‚
- ä¹è§‚é”åœ¨ Java ä¸­çš„åº”ç”¨å°±æ˜¯é‡‡ç”¨ `CAS` æœºåˆ¶ï¼ˆ`CAS` æ“ä½œé€šè¿‡ `Unsafe` ç±»æä¾›ï¼Œä½†è¿™ä¸ªç±»ä¸ç›´æ¥æš´éœ²ä¸º APIï¼Œæ‰€ä»¥éƒ½æ˜¯é—´æ¥ä½¿ç”¨ï¼Œå¦‚å„ç§åŸå­ç±»ï¼‰æˆ–ç‰ˆæœ¬å·æœºåˆ¶ï¼ˆä¹Ÿå¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰ç”¨å…¶ä»–èƒ½å¤Ÿæ ‡è®°æ•°æ®ç‰ˆæœ¬çš„å­—æ®µï¼Œå¦‚æ—¶é—´æˆ³ç­‰ã€‚ï¼‰ã€‚

**ç‰ˆæœ¬å·æœºåˆ¶**ï¼šç‰ˆæœ¬å·æœºåˆ¶çš„åŸºæœ¬æ€è·¯æ˜¯åœ¨æ•°æ®ä¸­å¢åŠ ä¸€ä¸ªå­—æ®µversionï¼Œè¡¨ç¤ºè¯¥æ•°æ®çš„ç‰ˆæœ¬å·ï¼Œæ¯å½“æ•°æ®è¢«ä¿®æ”¹ï¼Œç‰ˆæœ¬å·åŠ 1ã€‚å½“æŸä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®æ—¶ï¼Œå°†è¯¥æ•°æ®çš„ç‰ˆæœ¬å·ä¸€èµ·æŸ¥å‡ºæ¥ï¼›å½“è¯¥çº¿ç¨‹æ›´æ–°æ•°æ®æ—¶ï¼Œåˆ¤æ–­å½“å‰ç‰ˆæœ¬å·ä¸ä¹‹å‰è¯»å–çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´æ‰è¿›è¡Œæ“ä½œã€‚

è€ƒè™‘è¿™æ ·ä¸€ç§åœºæ™¯ï¼šæ¸¸æˆç³»ç»Ÿéœ€è¦æ›´æ–°ç©å®¶çš„é‡‘å¸æ•°ï¼Œæ›´æ–°åçš„é‡‘å¸æ•°ä¾èµ–äºå½“å‰çŠ¶æ€(å¦‚é‡‘å¸æ•°ã€ç­‰çº§ç­‰)ï¼Œå› æ­¤æ›´æ–°å‰éœ€è¦å…ˆæŸ¥è¯¢ç©å®¶å½“å‰çŠ¶æ€ã€‚

ä¸‹é¢çš„å®ç°æ–¹å¼ï¼Œæ²¡æœ‰è¿›è¡Œä»»ä½•çº¿ç¨‹å®‰å…¨æ–¹é¢çš„ä¿æŠ¤ã€‚å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹åœ¨queryå’Œupdateä¹‹é—´æ›´æ–°äº†ç©å®¶çš„ä¿¡æ¯ï¼Œä¼šå¯¼è‡´ç©å®¶é‡‘å¸æ•°çš„ä¸å‡†ç¡®ã€‚

```java
@Transactional
public void updateCoins(Integer playerId){
    //æ ¹æ®player_idæŸ¥è¯¢ç©å®¶ä¿¡æ¯
    Player player = query("select coins, level from player where player_id = {0}", playerId);
    //æ ¹æ®ç©å®¶å½“å‰ä¿¡æ¯åŠå…¶ä»–ä¿¡æ¯ï¼Œè®¡ç®—æ–°çš„é‡‘å¸æ•°
    Long newCoins = â€¦â€¦;
    //æ›´æ–°é‡‘å¸æ•°
    update("update player set coins = {0} where player_id = {1}", newCoins, playerId);
}
```

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæ‚²è§‚é”é€šè¿‡åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨æŸ¥è¯¢ç©å®¶ä¿¡æ¯æ—¶ï¼Œä½¿ç”¨select â€¦â€¦ for updateè¿›è¡ŒæŸ¥è¯¢ï¼›è¯¥æŸ¥è¯¢è¯­å¥ä¼šä¸ºè¯¥ç©å®¶æ•°æ®åŠ ä¸Šæ’å®ƒé”ï¼Œç›´åˆ°äº‹åŠ¡æäº¤æˆ–å›æ»šæ—¶æ‰ä¼šé‡Šæ”¾æ’å®ƒé”ï¼›åœ¨æ­¤æœŸé—´ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è¯•å›¾æ›´æ–°è¯¥ç©å®¶ä¿¡æ¯æˆ–è€…æ‰§è¡Œselect for updateï¼Œä¼šè¢«é˜»å¡ã€‚

```java
@Transactional
public void updateCoins(Integer playerId){
    //æ ¹æ®player_idæŸ¥è¯¢ç©å®¶ä¿¡æ¯ï¼ˆåŠ æ’å®ƒé”ï¼‰
    Player player = queryForUpdate("select coins, level from player where player_id = {0} for update", playerId);
    //æ ¹æ®ç©å®¶å½“å‰ä¿¡æ¯åŠå…¶ä»–ä¿¡æ¯ï¼Œè®¡ç®—æ–°çš„é‡‘å¸æ•°
    Long newCoins = â€¦â€¦;
    //æ›´æ–°é‡‘å¸æ•°
    update("update player set coins = {0} where player_id = {1}", newCoins, playerId);
}
```

ç‰ˆæœ¬å·æœºåˆ¶åˆ™æ˜¯å¦ä¸€ç§æ€è·¯ï¼Œå®ƒä¸ºç©å®¶ä¿¡æ¯å¢åŠ ä¸€ä¸ªå­—æ®µï¼šversionã€‚åœ¨åˆæ¬¡æŸ¥è¯¢ç©å®¶ä¿¡æ¯æ—¶ï¼ŒåŒæ—¶æŸ¥è¯¢å‡ºversionä¿¡æ¯ï¼›åœ¨æ‰§è¡Œupdateæ“ä½œæ—¶ï¼Œæ ¡éªŒversionæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœversionå˜åŒ–ï¼Œåˆ™ä¸è¿›è¡Œæ›´æ–°ã€‚

```java
@Transactional
public void updateCoins(Integer playerId){
    //æ ¹æ®player_idæŸ¥è¯¢ç©å®¶ä¿¡æ¯ï¼ŒåŒ…å«versionä¿¡æ¯
    Player player = query("select coins, level, version from player where player_id = {0}", playerId);
    //æ ¹æ®ç©å®¶å½“å‰ä¿¡æ¯åŠå…¶ä»–ä¿¡æ¯ï¼Œè®¡ç®—æ–°çš„é‡‘å¸æ•°
    Long newCoins = â€¦â€¦;
    //æ›´æ–°é‡‘å¸æ•°ï¼Œæ¡ä»¶ä¸­å¢åŠ å¯¹versionçš„æ ¡éªŒ
    update("update player set coins = {0}, version = version + 1 where player_id = {1} and version = {2}", newCoins, playerId, player.version);
}
```

## 1.2 å…¬å¹³é”ä¸éå…¬å¹³é”

- **å…¬å¹³é”** - å…¬å¹³é”æ˜¯æŒ‡ **å¤šçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”**ã€‚
- **éå…¬å¹³é”** - éå…¬å¹³é”æ˜¯æŒ‡ **å¤šçº¿ç¨‹ä¸æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”** ã€‚è¿™å°±å¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬ï¼ˆåæ¥è€…å±…ä¸Šï¼‰æˆ–è€…é¥¥é¥¿ç°è±¡ï¼ˆæŸçº¿ç¨‹æ€»æ˜¯æŠ¢ä¸è¿‡åˆ«çš„çº¿ç¨‹ï¼Œå¯¼è‡´å§‹ç»ˆæ— æ³•æ‰§è¡Œï¼‰ã€‚

å…¬å¹³é”ä¸ºäº†ä¿è¯çº¿ç¨‹ç”³è¯·é¡ºåºï¼ŒåŠ¿å¿…è¦ä»˜å‡ºä¸€å®šçš„æ€§èƒ½ä»£ä»·ï¼Œå› æ­¤å…¶ååé‡ä¸€èˆ¬ä½äºéå…¬å¹³é”ã€‚

å…¬å¹³é”ä¸éå…¬å¹³é” åœ¨ Java ä¸­çš„å…¸å‹å®ç°ï¼š

- **`synchronized` åªæ”¯æŒéå…¬å¹³é”**ã€‚
- **`ReentrantLock` ã€`ReentrantReadWriteLock`ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œä½†æ”¯æŒå…¬å¹³é”**ã€‚

`ReentrantLock`æä¾›äº†å…¬å¹³å’Œéå…¬å¹³é”çš„å®ç°ï¼š

- å…¬å¹³é”ï¼š`ReentrantLock pairLock = new ReentrantLock(true);`
- éå…¬å¹³é”ï¼š`ReentrantLock pairLock = new ReentrantLock(false);`è‹¥æ„é€ å‡½æ•°ä¸ä¼ å‚æ•°ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ã€‚

```java
public ReentrantLock() {
    sync = new NonfairSync();
}

/**
     * Creates an instance of {@code ReentrantLock} with the
     * given fairness policy.
     *
     * @param fair {@code true} if this lock should use a fair ordering policy
     */
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

## 1.3 ç‹¬äº«é”ä¸å…±äº«é”

ç‹¬äº«é”ä¸å…±äº«é”æ˜¯ä¸€ç§å¹¿ä¹‰ä¸Šçš„è¯´æ³•ï¼Œä»å®é™…ç”¨é€”ä¸Šæ¥çœ‹ï¼Œä¹Ÿå¸¸è¢«ç§°ä¸ºäº’æ–¥é”ä¸è¯»å†™é”ã€‚

- **ç‹¬äº«é”** - ç‹¬äº«é”æ˜¯æŒ‡ **é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰**ã€‚
- **å…±äº«é”** - å…±äº«é”æ˜¯æŒ‡ **é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰**ã€‚

ç‹¬äº«é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œç”±äºæ¯æ¬¡è®¿é—®æ•°æ®éƒ½å…ˆåŠ ä¸Šäº’æ–¥é”ï¼Œé™åˆ¶äº†å¹¶å‘æ€§ï¼Œå› ä¸ºè¯»æ“ä½œå¹¶ä¸ä¼šå½±å“æ•°æ®çš„ä¸€ç›´æ€§ã€‚

å…±äº«é”æ˜¯ä¸€ç§ä¹è§‚é”ï¼Œæ”¾æ¬¾äº†åŠ é”æ¡ä»¶ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè¯»æ“ä½œã€‚

ç‹¬äº«é”ä¸å…±äº«é”åœ¨ Java ä¸­çš„å…¸å‹å®ç°ï¼š

- **`synchronized` ã€`ReentrantLock` åªæ”¯æŒç‹¬äº«é”**ã€‚
- **`ReentrantReadWriteLock` å…¶å†™é”æ˜¯ç‹¬äº«é”ï¼Œå…¶è¯»é”æ˜¯å…±äº«é”**ã€‚è¯»é”æ˜¯å…±äº«é”ä½¿å¾—å¹¶å‘è¯»æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œè¯»å†™ï¼Œå†™è¯» ï¼Œå†™å†™çš„è¿‡ç¨‹æ˜¯äº’æ–¥çš„ã€‚

## 1.4 å¯é‡å…¥é”

**å¯é‡å…¥é”ï¼Œé¡¾åæ€ä¹‰ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥é‡å¤è·å–åŒä¸€æŠŠé”**ã€‚å³åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–äº†é”ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚

å¯é‡å…¥é”çš„**åŸç†**æ˜¯åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ ‡ç¤ºï¼Œç”¨æ¥æ ‡ç¤ºè¯¥é”ç›®å‰è¢«å“ªä¸ªçº¿ç¨‹å ç”¨ï¼Œç„¶åå…³è”ä¸€ä¸ªè®¡æ•°å™¨ã€‚ä¸€å¼€å§‹è®¡æ•°å™¨å€¼ä¸º0ï¼Œè¯´æ˜è¯¥é”æ²¡æœ‰è¢«ä»»ä½•çº¿ç¨‹å ç”¨ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†è¯¥é”æ—¶ï¼Œè®¡æ•°å™¨çš„å€¼ä¼šå˜æˆ1ï¼Œè¿™æ—¶å…¶å®ƒçº¿ç¨‹å†æ¥è·å–è¯¥é”æ—¶ä¼šå‘ç°é”çš„æ‰€æœ‰è€…ä¸æ˜¯è‡ªå·±è€Œè¢«é˜»å¡æŒ‚èµ·ã€‚

ä½†æ˜¯å½“è·å–äº†è¯¥é”çš„çº¿ç¨‹å†æ¬¡è·å–é”æ—¶å‘ç°æ‹¥æœ‰è€…æ˜¯è‡ªå·±ï¼Œå°±ä¼šæŠŠè®¡æ•°å™¨å€¼åŠ 1ï¼Œå½“é‡Šæ”¾é”åè®¡æ•°å™¨å€¼å‡1ã€‚å½“è®¡æ•°å™¨å€¼ä¸º0æ—¶ï¼Œé”é‡Œé¢çš„çº¿ç¨‹æ ‡ç¤ºè¢«é‡ç½®ä¸ºnullï¼Œè¿™æ—¶å€™è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’æ¥ç«äº‰è·å–è¯¥é”ã€‚

**å¯é‡å…¥é”å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…æ­»é”**ã€‚

- **`ReentrantLock` ã€`ReentrantReadWriteLock` æ˜¯å¯é‡å…¥é”**ã€‚è¿™ç‚¹ï¼Œä»å…¶å‘½åä¹Ÿä¸éš¾çœ‹å‡ºã€‚
- **`synchronized` ä¹Ÿæ˜¯ä¸€ä¸ªå¯é‡å…¥é”**ã€‚

ã€ç¤ºä¾‹ã€‘`synchronized` çš„å¯é‡å…¥ç¤ºä¾‹

```java
synchronized void setA() throws Exception{
    Thread.sleep(1000);
    setB();
}

synchronized void setB() throws Exception{
    Thread.sleep(1000);
}
```

ä¸Šé¢çš„ä»£ç å°±æ˜¯ä¸€ä¸ªå…¸å‹åœºæ™¯ï¼šå¦‚æœä½¿ç”¨çš„é”ä¸æ˜¯å¯é‡å…¥é”çš„è¯ï¼Œ`setB` å¯èƒ½ä¸ä¼šè¢«å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œä»è€Œé€ æˆæ­»é”ã€‚

ã€ç¤ºä¾‹ã€‘`ReentrantLock` çš„å¯é‡å…¥ç¤ºä¾‹

```java
class Task {

    private int value;
    private final Lock lock = new ReentrantLock();

    public Task() {
        this.value = 0;
    }

    public int get() {
        // è·å–é”
        lock.lock();
        try {
            return value;
        } finally {
            // ä¿è¯é”èƒ½é‡Šæ”¾
            lock.unlock();
        }
    }

    public void addOne() {
        // è·å–é”
        lock.lock();
        try {
            // æ³¨æ„ï¼šæ­¤å¤„å·²ç»æˆåŠŸè·å–é”ï¼Œè¿›å…¥ get æ–¹æ³•åï¼Œåˆå°è¯•è·å–é”ï¼Œ
            // å¦‚æœé”ä¸æ˜¯å¯é‡å…¥çš„ï¼Œä¼šå¯¼è‡´æ­»é”
            value = 1 + get();
        } finally {
            // ä¿è¯é”èƒ½é‡Šæ”¾
            lock.unlock();
        }
    }

}
```

## 1.5 è‡ªæ—‹é”

**è‡ªæ—‹é”åˆ™æ˜¯**ï¼Œå½“å‰çº¿ç¨‹å†è·å–é”æ—¶ï¼Œå¦‚æœå‘ç°å·²ç»è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œå®ƒä¸é©¬ä¸Šé˜»å¡è‡ªå·±ï¼Œåœ¨ä¸æ”¾å¼ƒCPUä½¿ç”¨æƒçš„æƒ…å†µä¸‹ï¼Œå¤šæ¬¡å°è¯•è·å–ï¼ˆé»˜è®¤æ¬¡æ•°æ˜¯10.å¯ä»¥ä½¿ç”¨â€“XX:PreBlockSpinshå‚æ•°è®¾ç½®è¯¥å€¼ï¼‰ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨åé¢å‡ æ¬¡å°è¯•ä¸­å…¶å®ƒçº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ã€‚å¦‚æœå°è¯•æŒ‡å®šæ¬¡æ•°åä»æ²¡æœ‰è·å–åˆ°é”åˆ™å½“å‰çº¿ç¨‹æ‰ä¼šè¢«é˜»å¡æŒ‚èµ·ã€‚

## 1.6  åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”

æ‰€è°“è½»é‡çº§é”ä¸é‡é‡çº§é”ï¼ŒæŒ‡çš„æ˜¯é”æ§åˆ¶ç²’åº¦çš„ç²—ç»†ã€‚æ˜¾ç„¶ï¼Œæ§åˆ¶ç²’åº¦è¶Šç»†ï¼Œé˜»å¡å¼€é”€è¶Šå°ï¼Œå¹¶å‘æ€§ä¹Ÿå°±è¶Šé«˜ã€‚

Java 1.6 ä»¥å‰ï¼Œé‡é‡çº§é”ä¸€èˆ¬æŒ‡çš„æ˜¯ `synchronized` ï¼Œè€Œè½»é‡çº§é”æŒ‡çš„æ˜¯ `volatile`ã€‚

Java 1.6 ä»¥åï¼Œé’ˆå¯¹ `synchronized` åšäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥ 4 ç§é”çŠ¶æ€ï¼š **æ— é”çŠ¶æ€**ã€**åå‘é”**ã€**è½»é‡çº§é”**å’Œ**é‡é‡çº§é”**ã€‚**é”å¯ä»¥å•å‘çš„ä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œå†ä»è½»é‡çº§é”å‡çº§åˆ°é‡é‡çº§é”** ã€‚

- **åå‘é”** - åå‘é”æ˜¯æŒ‡ä¸€æ®µåŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ã€‚é™ä½è·å–é”çš„ä»£ä»·ã€‚

- **è½»é‡çº§é”** - æ˜¯æŒ‡å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œæé«˜æ€§èƒ½ã€‚
- **é‡é‡çº§é”** - æ˜¯æŒ‡å½“é”ä¸ºè½»é‡çº§é”çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è™½ç„¶æ˜¯è‡ªæ—‹ï¼Œä½†è‡ªæ—‹ä¸ä¼šä¸€ç›´æŒç»­ä¸‹å»ï¼Œå½“è‡ªæ—‹ä¸€å®šæ¬¡æ•°çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰è·å–åˆ°é”ï¼Œå°±ä¼šè¿›å…¥é˜»å¡ï¼Œè¯¥é”è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šè®©å…¶ä»–ç”³è¯·çš„çº¿ç¨‹è¿›å…¥é˜»å¡ï¼Œæ€§èƒ½é™ä½ã€‚

## 1.7 åˆ†æ®µé”

åˆ†æ®µé”å…¶å®æ˜¯ä¸€ç§é”çš„è®¾è®¡ï¼Œå¹¶ä¸æ˜¯å…·ä½“çš„ä¸€ç§é”ã€‚æ‰€è°“åˆ†æ®µé”ï¼Œå°±æ˜¯æŠŠé”çš„å¯¹è±¡åˆ†æˆå¤šæ®µï¼Œæ¯æ®µç‹¬ç«‹æ§åˆ¶ï¼Œä½¿å¾—é”ç²’åº¦æ›´ç»†ï¼Œå‡å°‘é˜»å¡å¼€é”€ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ã€‚

`Hashtable` ä½¿ç”¨ `synchronized` ä¿®é¥°æ–¹æ³•æ¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œé‚£ä¹ˆé¢å¯¹çº¿ç¨‹çš„è®¿é—®ï¼ŒHashtable å°±ä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼Œæ‰€æœ‰çš„å…¶å®ƒçº¿ç¨‹åªèƒ½ç­‰å¾…ï¼Œè¿™ç§é˜»å¡æ–¹å¼çš„ååé‡æ˜¾ç„¶å¾ˆä½ã€‚

Java 1.7 ä»¥å‰çš„ `ConcurrentHashMap` å°±æ˜¯åˆ†æ®µé”çš„å…¸å‹æ¡ˆä¾‹ã€‚`ConcurrentHashMap` ç»´æŠ¤äº†ä¸€ä¸ª `Segment` æ•°ç»„ï¼Œä¸€èˆ¬ç§°ä¸ºåˆ†æ®µæ¡¶ã€‚

```java
final Segment<K,V>[] segments;
```

å½“æœ‰çº¿ç¨‹è®¿é—® `ConcurrentHashMap` çš„æ•°æ®æ—¶ï¼Œ`ConcurrentHashMap` ä¼šå…ˆæ ¹æ® hashCode è®¡ç®—å‡ºæ•°æ®åœ¨å“ªä¸ªæ¡¶ï¼ˆå³å“ªä¸ª Segmentï¼‰ï¼Œç„¶åé”ä½è¿™ä¸ª `Segment`ã€‚

## 1.8 æ˜¾ç¤ºé”å’Œå†…ç½®é”

Java 1.5 ä¹‹å‰ï¼Œåè°ƒå¯¹å…±äº«å¯¹è±¡çš„è®¿é—®æ—¶å¯ä»¥ä½¿ç”¨çš„æœºåˆ¶åªæœ‰ `synchronized` å’Œ `volatile`ã€‚è¿™ä¸¤ä¸ªéƒ½å±äºå†…ç½®é”ï¼Œå³é”çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½æ˜¯ç”± JVM æ‰€æ§åˆ¶ã€‚

Java 1.5 ä¹‹åï¼Œå¢åŠ äº†æ–°çš„æœºåˆ¶ï¼š`ReentrantLock`ã€`ReentrantReadWriteLock` ï¼Œè¿™ç±»é”çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½å¯ä»¥ç”±ç¨‹åºæ‰€æ§åˆ¶ï¼Œæ‰€ä»¥å¸¸è¢«ç§°ä¸ºæ˜¾ç¤ºé”ã€‚

> ğŸ’¡ `synchronized` çš„ç”¨æ³•å’ŒåŸç†å¯ä»¥å‚è€ƒï¼š[Java å¹¶å‘åŸºç¡€æœºåˆ¶ - synchronized (opens new window)](https://github.com/dunwu/javacore/blob/master/docs/concurrent/Javaå¹¶å‘æ ¸å¿ƒæœºåˆ¶.md#äºŒsynchronized)ã€‚
>
> ğŸ”” æ³¨æ„ï¼šå¦‚æœä¸éœ€è¦ `ReentrantLock`ã€`ReentrantReadWriteLock` æ‰€æä¾›çš„é«˜çº§åŒæ­¥ç‰¹æ€§ï¼Œ**åº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ `synchronized`** ã€‚ç†ç”±å¦‚ä¸‹ï¼š
>
> - Java 1.6 ä»¥åï¼Œ`synchronized` åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå…¶æ€§èƒ½å·²ç»ä¸ `ReentrantLock`ã€`ReentrantReadWriteLock` åŸºæœ¬ä¸ŠæŒå¹³ã€‚
> - ä»è¶‹åŠ¿æ¥çœ‹ï¼ŒJava æœªæ¥æ›´å¯èƒ½ä¼šä¼˜åŒ– `synchronized` ï¼Œè€Œä¸æ˜¯ `ReentrantLock`ã€`ReentrantReadWriteLock` ï¼Œå› ä¸º `synchronized` æ˜¯ JVM å†…ç½®å±æ€§ï¼Œå®ƒèƒ½æ‰§è¡Œä¸€äº›ä¼˜åŒ–ã€‚
> - `ReentrantLock`ã€`ReentrantReadWriteLock` ç”³è¯·å’Œé‡Šæ”¾é”éƒ½æ˜¯ç”±ç¨‹åºæ§åˆ¶ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½é€ æˆæ­»é”ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„ã€‚

ä»¥ä¸‹å¯¹æ¯”ä¸€ä¸‹æ˜¾ç¤ºé”å’Œå†…ç½®é”çš„å·®å¼‚ï¼š

- ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”
  - `synchronized` ä¸èƒ½ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”ã€‚è·å–é”å’Œé‡Šæ”¾é”éƒ½æ˜¯ JVM æ§åˆ¶çš„ã€‚
  - `ReentrantLock` å¯ä»¥ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”ã€‚ï¼ˆå¦‚æœå¿˜è®°é‡Šæ”¾é”ï¼Œå°±å¯èƒ½äº§ç”Ÿæ­»é”ï¼‰ã€‚
- å“åº”ä¸­æ–­
  - `synchronized` ä¸èƒ½å“åº”ä¸­æ–­ã€‚
  - `ReentrantLock` å¯ä»¥å“åº”ä¸­æ–­ã€‚
- è¶…æ—¶æœºåˆ¶
  - `synchronized` æ²¡æœ‰è¶…æ—¶æœºåˆ¶ã€‚
  - `ReentrantLock` æœ‰è¶…æ—¶æœºåˆ¶ã€‚`ReentrantLock` å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åè‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…ä¸€ç›´ç­‰å¾…ã€‚
- æ”¯æŒå…¬å¹³é”
  - `synchronized` åªæ”¯æŒéå…¬å¹³é”ã€‚
  - `ReentrantLock` æ”¯æŒéå…¬å¹³é”å’Œå…¬å¹³é”ã€‚
- æ˜¯å¦æ”¯æŒå…±äº«
  - è¢« `synchronized` ä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼Œåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ˆç‹¬äº«ï¼‰ã€‚å¦‚æœè¿™ä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿåªèƒ½ç­‰å¾…
  - `ReentrantLock` å¯ä»¥åŸºäº `Condition` çµæ´»çš„æ§åˆ¶åŒæ­¥æ¡ä»¶ã€‚
- æ˜¯å¦æ”¯æŒè¯»å†™åˆ†ç¦»
  - `synchronized` ä¸æ”¯æŒè¯»å†™é”åˆ†ç¦»ï¼›
  - `ReentrantReadWriteLock` æ”¯æŒè¯»å†™é”ï¼Œä»è€Œä½¿é˜»å¡è¯»å†™çš„æ“ä½œåˆ†å¼€ï¼Œæœ‰æ•ˆæé«˜å¹¶å‘æ€§ã€‚

# 2. Lock å’Œ Condition

## 2.1. ä¸ºä½•å¼•å…¥ Lock å’Œ Condition

**Java SDK å¹¶å‘åŒ…é€šè¿‡ Lock å’Œ Condition ä¸¤ä¸ªæ¥å£æ¥å®ç°ç®¡ç¨‹ï¼Œå…¶ä¸­ Lock ç”¨äºè§£å†³äº’æ–¥é—®é¢˜ï¼ŒCondition ç”¨äºè§£å†³åŒæ­¥é—®é¢˜**

synchronized æ— æ³•é€šè¿‡**ç ´åä¸å¯æŠ¢å æ¡ä»¶**æ¥é¿å…æ­»é”ã€‚åŸå› æ˜¯ synchronized ç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥é˜»å¡çŠ¶æ€äº†ï¼Œè€Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå•¥éƒ½å¹²ä¸äº†ï¼Œä¹Ÿé‡Šæ”¾ä¸äº†çº¿ç¨‹å·²ç»å æœ‰çš„èµ„æºã€‚

ä¸å†…ç½®é” `synchronized` ä¸åŒçš„æ˜¯ï¼Œ**`Lock` æä¾›äº†ä¸€ç»„æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ã€å®šæ—¶çš„ä»¥åŠå¯ä¸­æ–­çš„é”æ“ä½œ**ï¼Œæ‰€æœ‰è·å–é”ã€é‡Šæ”¾é”çš„æ“ä½œéƒ½æ˜¯æ˜¾å¼çš„æ“ä½œã€‚

- **èƒ½å¤Ÿå“åº”ä¸­æ–­**ã€‚synchronized çš„é—®é¢˜æ˜¯ï¼ŒæŒæœ‰é” A åï¼Œå¦‚æœå°è¯•è·å–é” B å¤±è´¥ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¸€æ—¦å‘ç”Ÿæ­»é”ï¼Œå°±æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å”¤é†’é˜»å¡çš„çº¿ç¨‹ã€‚ä½†å¦‚æœé˜»å¡çŠ¶æ€çš„çº¿ç¨‹èƒ½å¤Ÿå“åº”ä¸­æ–­ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ç»™é˜»å¡çš„çº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå”¤é†’å®ƒï¼Œé‚£å®ƒå°±æœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é” Aã€‚è¿™æ ·å°±ç ´åäº†ä¸å¯æŠ¢å æ¡ä»¶äº†ã€‚
- **æ”¯æŒè¶…æ—¶**ã€‚å¦‚æœçº¿ç¨‹åœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…æ²¡æœ‰è·å–åˆ°é”ï¼Œä¸æ˜¯è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¹Ÿæœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é”ã€‚è¿™æ ·ä¹Ÿèƒ½ç ´åä¸å¯æŠ¢å æ¡ä»¶ã€‚
- **éé˜»å¡åœ°è·å–é”**ã€‚å¦‚æœå°è¯•è·å–é”å¤±è´¥ï¼Œå¹¶ä¸è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¹Ÿæœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é”ã€‚è¿™æ ·ä¹Ÿèƒ½ç ´åä¸å¯æŠ¢å æ¡ä»¶ã€‚

## 2.2. Lock æ¥å£

`Lock` çš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface Lock {
    void lock();
    void lockInterruptibly() throws InterruptedException;
    boolean tryLock();
    boolean tryLock(long time, TimeUnit unit) throws InterruptedException;
    void unlock();
    Condition newCondition();
}
```

- `lock()` - è·å–é”ã€‚
- `unlock()` - é‡Šæ”¾é”ã€‚
- `tryLock()` - å°è¯•è·å–é”ï¼Œä»…åœ¨è°ƒç”¨æ—¶é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„æƒ…å†µä¸‹ï¼Œæ‰è·å–è¯¥é”ã€‚
- `tryLock(long time, TimeUnit unit)` - å’Œ `tryLock()` ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºé™å®šæ—¶é—´ï¼Œå¦‚æœé™å®šæ—¶é—´å†…æœªè·å–åˆ°é”ï¼Œè§†ä¸ºå¤±è´¥ã€‚
- `lockInterruptibly()` - é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œä¸”çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è·å–é”ã€‚
- `newCondition()` - è¿”å›ä¸€ä¸ªç»‘å®šåˆ° `Lock` å¯¹è±¡ä¸Šçš„ `Condition` å®ä¾‹ã€‚

## 2.3. Condition

**Condition å®ç°äº†ç®¡ç¨‹æ¨¡å‹é‡Œé¢çš„æ¡ä»¶å˜é‡**ã€‚

å‰é¢ä¸­æè¿‡ `Lock` æ¥å£ä¸­ æœ‰ä¸€ä¸ª `newCondition()` æ–¹æ³•ç”¨äºè¿”å›ä¸€ä¸ªç»‘å®šåˆ° `Lock` å¯¹è±¡ä¸Šçš„ `Condition` å®ä¾‹ã€‚

åœ¨å•çº¿ç¨‹ä¸­ï¼Œä¸€æ®µä»£ç çš„æ‰§è¡Œå¯èƒ½ä¾èµ–äºæŸä¸ªçŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³çŠ¶æ€æ¡ä»¶ï¼Œä»£ç å°±ä¸ä¼šè¢«æ‰§è¡Œï¼ˆå…¸å‹çš„åœºæ™¯ï¼Œå¦‚ï¼š`if ... else ...`ï¼‰ã€‚åœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åˆ¤æ–­æŸä¸ªçŠ¶æ€æ¡ä»¶æ—¶ï¼Œå…¶çŠ¶æ€å¯èƒ½æ˜¯ç”±äºå…¶ä»–çº¿ç¨‹çš„æ“ä½œè€Œæ”¹å˜ï¼Œè¿™æ—¶å°±éœ€è¦æœ‰ä¸€å®šçš„åè°ƒæœºåˆ¶æ¥ç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»ï¼Œæ•°æ®åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹é”ä¿®æ”¹ï¼Œä¸”ä¿®æ”¹çš„æ•°æ®çŠ¶æ€è¢«æ‰€æœ‰çº¿ç¨‹æ‰€æ„ŸçŸ¥ã€‚

Java 1.5 ä¹‹å‰ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ `Object` ç±»ä¸­çš„ `wait`ã€`notify`ã€`notifyAll` é…åˆ `synchronized` æ¥è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ï¼ˆå¦‚æœä¸äº†è§£å…¶ç‰¹æ€§ï¼Œå¯ä»¥å‚è€ƒï¼š[waitã€notify/notifyAll](https://floweryu.blog.csdn.net/article/details/110222425)ï¼‰

`wait`ã€`notify`ã€`notifyAll` éœ€è¦é…åˆ `synchronized` ä½¿ç”¨ï¼Œä¸é€‚ç”¨äº `Lock`ã€‚è€Œä½¿ç”¨ `Lock` çš„çº¿ç¨‹ï¼Œå½¼æ­¤é—´é€šä¿¡åº”è¯¥ä½¿ç”¨ `Condition` ã€‚è¿™å¯ä»¥ç†è§£ä¸ºï¼Œä»€ä¹ˆæ ·çš„é”é…ä»€ä¹ˆæ ·çš„é’¥åŒ™ã€‚**å†…ç½®é”ï¼ˆ`synchronized`ï¼‰é…åˆå†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ`wait`ã€`notify`ã€`notifyAll` ï¼‰ï¼Œæ˜¾å¼é”ï¼ˆ`Lock`ï¼‰é…åˆæ˜¾å¼æ¡ä»¶é˜Ÿåˆ—ï¼ˆ`Condition` ï¼‰**ã€‚

### Condition çš„ç‰¹æ€§

`Condition` æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface Condition {
    void await() throws InterruptedException;
    void awaitUninterruptibly();
    long awaitNanos(long nanosTimeout) throws InterruptedException;
    boolean await(long time, TimeUnit unit) throws InterruptedException;
    boolean awaitUntil(Date deadline) throws InterruptedException;
    void signal();
    void signalAll();
}
```

å…¶ä¸­ï¼Œ`await`ã€`signal`ã€`signalAll` ä¸ `wait`ã€`notify`ã€`notifyAll` ç›¸å¯¹åº”ï¼ŒåŠŸèƒ½ä¹Ÿç›¸ä¼¼ã€‚é™¤æ­¤ä»¥å¤–ï¼Œ`Condition` ç›¸æ¯”å†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ `wait`ã€`notify`ã€`notifyAll` ï¼‰ï¼Œæä¾›äº†æ›´ä¸ºä¸°å¯Œçš„åŠŸèƒ½ï¼š

- æ¯ä¸ªé”ï¼ˆ`Lock`ï¼‰ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ª `Condition`ï¼Œè¿™æ„å‘³ç€é”çš„çŠ¶æ€æ¡ä»¶å¯ä»¥æœ‰å¤šä¸ªã€‚
- æ”¯æŒå…¬å¹³çš„æˆ–éå…¬å¹³çš„é˜Ÿåˆ—æ“ä½œã€‚
- æ”¯æŒå¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š`awaitUninterruptibly()` ã€‚
- æ”¯æŒå¯å®šæ—¶çš„ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š`awaitNanos(long)` ã€`await(long, TimeUnit)`ã€`awaitUntil(Date)`ã€‚

# 3. `ReentrantLock`

`ReentrantLock` ç±»æ˜¯ `Lock` æ¥å£çš„å…·ä½“å®ç°ï¼Œä¸å†…ç½®é” `synchronized` ç›¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯ä¸€ä¸ª**å¯é‡å…¥çš„ç‹¬å é”**ã€‚

ç±»å›¾ç»“æ„:

![image-20210301174230467](https://i.loli.net/2021/03/01/VrZvcSt69GQOa1d.png)

## 3.1. `ReentrantLock` çš„ç‰¹æ€§

`ReentrantLock` çš„ç‰¹æ€§å¦‚ä¸‹ï¼š

- **`ReentrantLock` æä¾›äº†ä¸ `synchronized` ç›¸åŒçš„äº’æ–¥æ€§ã€å†…å­˜å¯è§æ€§å’Œå¯é‡å…¥æ€§**ã€‚
- `ReentrantLock` **æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”**ï¼ˆé»˜è®¤ï¼‰ä¸¤ç§æ¨¡å¼ã€‚
- `ReentrantLock`å®ç°äº†`Lock`æ¥å£ï¼Œæ”¯æŒäº†`synchronized`æ‰€ä¸å…·å¤‡çš„çµæ´»æ€§ã€‚
  - `synchronized` æ— æ³•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹
  - `synchronized` æ— æ³•åœ¨è¯·æ±‚è·å–ä¸€ä¸ªé”æ—¶æ— ä¼‘æ­¢åœ°ç­‰å¾…

## 3.2. `ReentrantLock` çš„ç”¨æ³•åŠåŸç†

### `ReentrantLock` çš„æ„é€ æ–¹æ³•

`ReentrantLock` æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼š

```java
public ReentrantLock() {
	sync = new NonfairSync();
}

public ReentrantLock(boolean fair) {
	sync = fair ? new FairSync() : new NonfairSync();
}
```

- `ReentrantLock()` - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ª**éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰**ï¼›
- `ReentrantLock(boolean)` - `new ReentrantLock(true)` ä¼šåˆå§‹åŒ–ä¸€ä¸ª**å…¬å¹³é”ï¼ˆFairSyncï¼‰**ã€‚

### `void lock()` æ–¹æ³•

- `lock()` - **æ— æ¡ä»¶è·å–é”**ã€‚å¦‚æœé”å½“å‰æ²¡æœ‰è¢«å…¶å®ƒçº¿ç¨‹å ç”¨å¹¶ä¸”å½“å‰çº¿ç¨‹ä¹‹å‰æ²¡æœ‰è·å–è¿‡é”ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šè·å–åˆ°é”ï¼Œç„¶åè®¾ç½®å½“å‰é”çš„æ‹¥æœ‰è€…ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¹¶è®¾ç½®AQSçš„çŠ¶æ€å€¼ä¸º1ï¼Œç„¶åç›´æ¥è¿”å›ã€‚å¦‚æœå½“å‰çº¿ç¨‹ä¹‹å‰å·²ç»è·å–è¿‡è¯¥é”ï¼Œåˆ™è¿™æ¬¡åªæ˜¯ç®€å•åœ°æŠŠAQSçŠ¶æ€å€¼åŠ 1åè¿”å›ã€‚å¦‚æœè¯¥é”å·²ç»è¢«å…¶å®ƒçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥AQSé˜Ÿåˆ—åé˜»å¡æŒ‚èµ·ã€‚
- `unlock()` - ç”¨äº**é‡Šæ”¾é”**ã€‚

> ğŸ”” æ³¨æ„ï¼šè¯·åŠ¡å¿…ç‰¢è®°ï¼Œè·å–é”æ“ä½œ **`lock()` å¿…é¡»åœ¨ `try catch` å—ä¸­è¿›è¡Œï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”æ“ä½œ `unlock()` æ”¾åœ¨ `finally` å—ä¸­è¿›è¡Œï¼Œä»¥ä¿è¯é”ä¸€å®šè¢«è¢«é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”çš„å‘ç”Ÿ**ã€‚

```java
public void lock() {
	sync.lock();
}
```

`ReentrantLock`çš„`Lock()`å§”æ‰˜ç»™äº†`sync`ç±», æ ¹æ®åˆ›å»º`ReentrantLock`æ„é€ å‡½æ•°é€‰æ‹©`sync`çš„å®ç°æ˜¯`NofairSync`è¿˜æ˜¯`FairSync`,è¿™ä¸ªé”æ˜¯ä¸€ä¸ªéå…¬å¹³é”æˆ–å…¬å¹³é”.

#### `NofairSync`éå…¬å¹³é”æƒ…å†µ

```java
final void lock() {
    // (1)CASè®¾ç½®çŠ¶æ€å€¼
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);	//è°ƒç”¨AQSçš„acquireæ–¹æ³•
}

protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
```

åœ¨(1)ä¸­,å› ä¸ºé»˜è®¤çš„AQSçŠ¶æ€å€¼ä¸º0,æ‰€ä»¥ç¬¬ä¸€ä¸ªè°ƒç”¨`Lock`çš„çº¿ç¨‹ä¼šé€šè¿‡CASè®¾ç½®çŠ¶æ€å€¼ä¸º1, CASæˆåŠŸåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–åˆ°äº†é”,ç„¶å`setExclusiveOwnerThread`è®¾ç½®è¯¥é”æŒæœ‰è€…æ˜¯å½“å‰çº¿ç¨‹.

å¦‚æœè¿™æ—¶æœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨`Lock`æ–¹æ³•ä¼å›¾è·å–è¯¥é”, CASä¼šå¤±è´¥, ç„¶åä¼šè°ƒç”¨AQSçš„`acquire`æ–¹æ³•. æ³¨æ„, ä¼ é€’å‚æ•°ä¸º1, ä¸‹é¢æ˜¯AQSçš„`acquire`æ ¸å¿ƒä»£ç :

```java
public final void acquire(long arg) {
    // (3)è°ƒç”¨ReentrantLocké‡å†™çš„tryAcquire
    if (!tryAcquire(arg) &&
        // tryAcquireè¿”å›falseä¼šæŠŠå½“å‰çº¿ç¨‹æ”¾å…¥AQSé˜»å¡é˜Ÿåˆ—
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

AQSå¹¶æ²¡æœ‰æä¾›å¯ç”¨çš„`tryAcquire`æ–¹æ³•,`tryAcquire`æ–¹æ³•éœ€è¦å­ç±»è‡ªå·±å®šåˆ¶åŒ–,æ‰€ä»¥(3)å¤„ä¼šè°ƒç”¨`ReentrantLock`é‡å†™çš„`tryAcquire`æ–¹æ³•.

```java
protected final boolean tryAcquire(int acquires) {
	return nonfairTryAcquire(acquires);
}

final boolean nonfairTryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    // (4)å½“å‰AQSçŠ¶æ€å€¼ä¸º0
    if (c == 0) {
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }	// (5)å½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

é¦–å…ˆä»£ç (4)ä¼šæŸ¥çœ‹å½“å‰çš„çŠ¶æ€å€¼æ˜¯å¦ä¸º0, ä¸º0è¯´æ˜å½“å‰**é”ç©ºé—²**, é‚£ä¹ˆå°±å°è¯•CASè·å–å½“å‰é”, å°†AQSçš„çŠ¶æ€å€¼ä»0è®¾ç½®ä¸º1, å¹¶è®¾ç½®å½“å‰é”çš„æŒæœ‰è€…ä¸ºå½“å‰çº¿ç¨‹, ç„¶åè¿”å›true. 

å¦‚æœå½“å‰**çŠ¶æ€å€¼ä¸ä¸º0**, åˆ™è¯´æ˜è¯¥é”å·²ç»è¢«æŸä¸ªçº¿ç¨‹æŒæœ‰, æ‰€ä»¥ä»£ç (5)æŸ¥çœ‹å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè¯¥é”çš„æŒæœ‰è€…, å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…, åˆ™çŠ¶æ€å€¼åŠ 1, ç„¶åè¿”å›true. éœ€è¦æ³¨æ„çš„æ˜¯: `nextc<0`è¯´æ˜å¯é‡å…¥æ¬¡æ•°æº¢å‡ºäº†. 

å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…, è¿”å›`false`, ç„¶åä¼šè¢«æ”¾å…¥AQSé˜»å¡é˜Ÿåˆ—.

**éå…¬å¹³é”çš„ä½“ç°**:

å‡è®¾çº¿ç¨‹Aè°ƒç”¨`lock()`æ–¹æ³•æ—¶æ‰§è¡Œåˆ°`nofairTryAcquire`çš„ä»£ç (4), å‘ç°å½“å‰çŠ¶æ€å€¼ä¸ä¸º0, æ‰€ä»¥æ‰§è¡Œä»£ç (5), å‘ç°å½“å‰çº¿ç¨‹ä¸æ˜¯çº¿ç¨‹æŒæœ‰è€…, åˆ™æ‰§è¡Œä»£ç (6)è¿”å›`false`, ç„¶åå½“å‰çº¿ç¨‹è¿›å…¥AQSé˜»å¡é˜Ÿåˆ—.

è¿™æ—¶çº¿ç¨‹Bä¹Ÿè°ƒç”¨äº†`lock()`æ–¹æ³•æ‰§è¡Œåˆ°`nonfairTryAcquire`çš„ä»£ç (4), å‘ç°å½“å‰çŠ¶æ€å€¼ä¸º0(å‡è®¾å æœ‰è¯¥é”çš„å…¶å®ƒçº¿ç¨‹é‡Šæ”¾äº†è¯¥é”), æ‰€ä»¥é€šè¿‡CASè®¾ç½®è·å–äº†è¯¥é”. æŒ‰é“ç†åº”è¯¥æ˜¯Aå…ˆè·å–é”, è¿™å°±æ˜¯éå…¬å¹³æ€§çš„ä½“ç°.

#### `FairSync`å…¬å¹³é”æƒ…å†µ

```java
protected final boolean tryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    // (7)å½“å‰çŠ¶æ€å€¼ä¸º0
    if (c == 0) {
        // (8)å…¬å¹³æ€§ç­–ç•¥
        if (!hasQueuedPredecessors() &&
            compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    // (9) å½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0)
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

å…¬å¹³çš„`tryAcquire`ä¸éå…¬å¹³çš„ç±»ä¼¼, ä¸åŒä¹‹å¤„åœ¨äº, ä»£ç (8)åœ¨è®¾ç½®CASå‰æ·»åŠ äº†`hasQueuedPredecessors`æ–¹æ³•, è¯¥æ–¹æ³•æ˜¯å®ç°å…¬å¹³æ€§çš„æ ¸å¿ƒä»£ç (åœ¨AQSæºç ä¸­):

```java
public final boolean hasQueuedPredecessors() {
    // The correctness of this depends on head being initialized
    // before tail and on head.next being accurate if the current
    // thread is first in queue.
    Node t = tail; // Read fields in reverse initialization order
    Node h = head;
    Node s;
    return h != t &&
        ((s = h.next) == null || s.thread != Thread.currentThread());
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­, å¦‚æœå½“å‰çº¿ç¨‹èŠ‚ç‚¹æœ‰å‰é©±èŠ‚ç‚¹åˆ™è¿”å›`true`, å¦åˆ™å¦‚æœå½“å‰AQSé˜Ÿåˆ—ä¸ºç©ºæˆ–è€…å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯AQSçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åˆ™è¿”å›`false`.å…¶ä¸­å¦‚æœ`h == t`åˆ™è¯´æ˜å½“å‰é˜Ÿåˆ—ä¸ºç©º, ç›´æ¥è¿”å›`false`, 

å¦‚æœ`h != t`å¹¶ä¸”`s == null`åˆ™è¯´æ˜æœ‰ä¸€ä¸ªå…ƒç´ å°†è¦ä½œä¸ºAQSçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿåˆ—, é‚£ä¹ˆè¿”å›`true`, å¦‚æœ`h != t`å¹¶ä¸”`s != null`å’Œ`s.thread != Thread.currentThread())`åˆ™è¯´æ˜é˜Ÿåˆ—é‡Œé¢ç¬¬ä¸€ä¸ªå…ƒç´ ä¸æ˜¯å½“å‰çº¿ç¨‹, é‚£ä¹ˆè¿”å›`true`

### `void lockInterruptibly()æ–¹æ³•`

è¯¥æ–¹æ³•ä¸`lock()`æ–¹æ³•ç±»ä¼¼, ä¸åŒä¹‹å¤„åœ¨äº, å®ƒèƒ½ä¸­æ–­è¿›è¡Œå“åº”, å°±æ˜¯å½“å‰çº¿ç¨‹åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶, å¦‚æœå…¶å®ƒçº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„`interrupt()`æ–¹æ³•, åˆ™å½“å‰çº¿ç¨‹ä¼šæŠ›å‡º`InterruptedException`å¼‚å¸¸. æºç åœ¨AQSåŒ…ä¸­.

- `lockInterruptibly()` - **å¯ä¸­æ–­è·å–é”**ã€‚å¯ä¸­æ–­è·å–é”å¯ä»¥åœ¨è·å¾—é”çš„åŒæ—¶ä¿æŒå¯¹ä¸­æ–­çš„å“åº”ã€‚å¯ä¸­æ–­è·å–é”æ¯”å…¶å®ƒè·å–é”çš„æ–¹å¼ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦ä¸¤ä¸ª `try-catch` å—ï¼ˆå¦‚æœåœ¨è·å–é”çš„æ“ä½œä¸­æŠ›å‡ºäº†`InterruptedException` ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ `try-finally` åŠ é”æ¨¡å¼ï¼‰ã€‚
  - ä¸¾ä¾‹æ¥è¯´ï¼šå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡ `lock.lockInterruptibly()` è·å–æŸä¸ªé”æ—¶ï¼Œè‹¥çº¿ç¨‹ A è·å–åˆ°äº†é”ï¼Œåˆ™çº¿ç¨‹ B åªèƒ½ç­‰å¾…ã€‚è‹¥æ­¤æ—¶å¯¹çº¿ç¨‹ B è°ƒç”¨ `threadB.interrupt()` æ–¹æ³•èƒ½å¤Ÿä¸­æ–­çº¿ç¨‹ B çš„ç­‰å¾…è¿‡ç¨‹ã€‚ç”±äº `lockInterruptibly()` çš„å£°æ˜ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ‰€ä»¥ `lock.lockInterruptibly()` å¿…é¡»æ”¾åœ¨ `try` å—ä¸­æˆ–è€…åœ¨è°ƒç”¨ `lockInterruptibly()` çš„æ–¹æ³•å¤–å£°æ˜æŠ›å‡º `InterruptedException`ã€‚

> ğŸ”” æ³¨æ„ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ä¹‹åï¼Œæ˜¯ä¸ä¼šè¢« `interrupt()` æ–¹æ³•ä¸­æ–­çš„ã€‚å•ç‹¬è°ƒç”¨ `interrupt()` æ–¹æ³•ä¸èƒ½ä¸­æ–­æ­£åœ¨è¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ï¼Œåªèƒ½ä¸­æ–­é˜»å¡çŠ¶æ€ä¸­çš„çº¿ç¨‹ã€‚å› æ­¤å½“é€šè¿‡ `lockInterruptibly()` æ–¹æ³•è·å–æŸä¸ªé”æ—¶ï¼Œå¦‚æœæœªè·å–åˆ°é”ï¼Œåªæœ‰åœ¨ç­‰å¾…çš„çŠ¶æ€ä¸‹ï¼Œæ‰å¯ä»¥å“åº”ä¸­æ–­ã€‚

```java
public void lockInterruptibly() throws InterruptedException {
    sync.acquireInterruptibly(1);
}

public final void acquireInterruptibly(long arg)
    throws InterruptedException {
    // å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­, åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸
    if (Thread.interrupted())
        throw new InterruptedException();
    // å°è¯•è·å–èµ„æº
    if (!tryAcquire(arg))
        // è°ƒç”¨AQSå¯è¢«ä¸­æ–­çš„æ–¹æ³•
        doAcquireInterruptibly(arg);
}
```

### `boolean tryLock()æ–¹æ³•`

å°è¯•è·å–é”, å¦‚æœå½“å‰è¯¥é”æ²¡æœ‰è¢«å…¶å®ƒçº¿ç¨‹æŒæœ‰, åˆ™å½“å‰çº¿ç¨‹è·å–è¯¥é”å¹¶è¿”å›`true`, å¦åˆ™è¿”å›`false`. è¯¥æ–¹æ³•ä¸ä¼šå¼•èµ·å½“å‰çº¿ç¨‹é˜»å¡.

- `tryLock()` - **å¯è½®è¯¢è·å–é”**ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å› trueï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å› falseã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•**æ— è®ºæˆè´¥éƒ½ä¼šç«‹å³è¿”å›**ï¼Œè·å–ä¸åˆ°é”ï¼ˆé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼‰æ—¶ä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚
- `tryLock(long, TimeUnit)` - **å¯å®šæ—¶è·å–é”**ã€‚å’Œ `tryLock()` ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºè¿™ä¸ªæ–¹æ³•åœ¨**è·å–ä¸åˆ°é”æ—¶ä¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´**ï¼Œåœ¨æ—¶é—´æœŸé™ä¹‹å†…å¦‚æœè¿˜è·å–ä¸åˆ°é”ï¼Œå°±è¿”å› falseã€‚å¦‚æœå¦‚æœä¸€å¼€å§‹æ‹¿åˆ°é”æˆ–è€…åœ¨ç­‰å¾…æœŸé—´å†…æ‹¿åˆ°äº†é”ï¼Œåˆ™è¿”å› trueã€‚

```java
public boolean tryLock() {
    return sync.nonfairTryAcquire(1);
}

final boolean nonfairTryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) {
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}

public boolean tryLock(long timeout, TimeUnit unit)
    throws InterruptedException {
    // è°ƒç”¨AQSåŒ…ä¸­çš„tryAcquireNanosæ–¹æ³•
    return sync.tryAcquireNanos(1, unit.toNanos(timeout));
}
```

æºç çš„å®ç°ä¸éå…¬å¹³é”çš„`tryAcquire()`æ–¹æ³•ç±»ä¼¼, æ‰€ä»¥`tryLock()`ä½¿ç”¨çš„æ˜¯éå…¬å¹³é”.

### `void unlock()`æ–¹æ³•

å°è¯•é‡Šæ”¾å½“å‰é”, å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰è¯¥é”, åˆ™è°ƒç”¨è¯¥æ–¹æ³•ä¼šè®©è¯¥çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æŒæœ‰çš„AQSçŠ¶æ€å€¼å‡1, å¦‚æœå‡å»1åå½“å‰çŠ¶æ€å€¼ä¸º0, åˆ™å½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾è¯¥é”, å¦åˆ™ä»…ä»…å‡1è€Œå·². å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¯¥é”è€Œè°ƒç”¨äº†è¯¥æ–¹æ³•åˆ™ä¼šæŠ›å‡º`IllegalMonitorStateException`å¼‚å¸¸.

```java
public void unlock() {
    sync.release(1);
}

protected final boolean tryRelease(int releases) {
    int c = getState() - releases;
    // (11) å¦‚æœä¸æ˜¯é”æŒæœ‰åˆ™è°ƒç”¨unlockåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    // (12) å¦‚æœå½“å‰å¯é‡å…¥æ¬¡æ•°ä¸º0, åˆ™æ¸…ç©ºæŒæœ‰è¯¥é”çš„çº¿ç¨‹
    if (c == 0) {
        free = true;
        setExclusiveOwnerThread(null);
    }
    // (13) è®¾ç½®å¯é‡å…¥æ¬¡æ•°ä¸ºåŸå§‹å€¼-1
    setState(c);
    return free;
}
```

# 4. `ReentrantReadWriteLock`

`ReadWriteLock` é€‚ç”¨äº**è¯»å¤šå†™å°‘çš„åœºæ™¯**ã€‚

`ReentrantReadWriteLock` ç±»æ˜¯ `ReadWriteLock` æ¥å£çš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„è¯»å†™é”ã€‚`ReentrantReadWriteLock` ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼Œå°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚

è¯»å†™é”ï¼Œå¹¶ä¸æ˜¯ Java è¯­è¨€ç‰¹æœ‰çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå¹¿ä¸ºä½¿ç”¨çš„é€šç”¨æŠ€æœ¯ï¼Œæ‰€æœ‰çš„è¯»å†™é”éƒ½éµå®ˆä»¥ä¸‹ä¸‰æ¡åŸºæœ¬åŸåˆ™ï¼š

- å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«å˜é‡ï¼›
- åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…±äº«å˜é‡ï¼›
- å¦‚æœä¸€ä¸ªå†™çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œæ­¤æ—¶ç¦æ­¢è¯»çº¿ç¨‹è¯»å…±äº«å˜é‡ã€‚

è¯»å†™é”ä¸äº’æ–¥é”çš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯**è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«å˜é‡**ï¼Œè€Œäº’æ–¥é”æ˜¯ä¸å…è®¸çš„ï¼Œè¿™æ˜¯è¯»å†™é”åœ¨è¯»å¤šå†™å°‘åœºæ™¯ä¸‹æ€§èƒ½ä¼˜äºäº’æ–¥é”çš„å…³é”®ã€‚ä½†**è¯»å†™é”çš„å†™æ“ä½œæ˜¯äº’æ–¥çš„**ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨å†™å…±äº«å˜é‡çš„æ—¶å€™ï¼Œæ˜¯ä¸å…è®¸å…¶ä»–çº¿ç¨‹æ‰§è¡Œå†™æ“ä½œå’Œè¯»æ“ä½œã€‚

## 4.1 `ReentrantReadWriteLock`çš„ç‰¹æ€§

`ReentrantReadWriteLock` çš„ç‰¹æ€§å¦‚ä¸‹ï¼š

- **`ReentrantReadWriteLock` é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯**ã€‚å¦‚æœæ˜¯å†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œç”±äº `ReentrantReadWriteLock` å…¶å†…éƒ¨å®ç°æ¯” `ReentrantLock` å¤æ‚ï¼Œæ€§èƒ½å¯èƒ½åè€Œè¦å·®ä¸€äº›ã€‚å¦‚æœå­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚ç”±äº `ReentrantReadWriteLock` çš„è¯»å†™é”ï¼ˆ`ReadLock`ã€`WriteLock`ï¼‰éƒ½å®ç°äº† `Lock` æ¥å£ï¼Œæ‰€ä»¥è¦æ›¿æ¢ä¸º `ReentrantLock` ä¹Ÿè¾ƒä¸ºå®¹æ˜“ã€‚

- `ReentrantReadWriteLock` å®ç°äº† `ReadWriteLock` æ¥å£ï¼Œæ”¯æŒäº† `ReentrantLock` æ‰€ä¸å…·å¤‡çš„è¯»å†™é”åˆ†ç¦»ã€‚`ReentrantReadWriteLock` ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼ˆ`ReadLock`ã€`WriteLock`ï¼‰ã€‚å°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚`ReentrantReadWriteLock` çš„åŠ é”ç­–ç•¥æ˜¯ï¼š**å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œä½†æ¯æ¬¡åªå…è®¸ä¸€ä¸ªå†™æ“ä½œ**ã€‚
- `ReentrantReadWriteLock` ä¸ºè¯»å†™é”éƒ½æä¾›äº†å¯é‡å…¥çš„åŠ é”è¯­ä¹‰ã€‚
- `ReentrantReadWriteLock` æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰ä¸¤ç§æ¨¡å¼ã€‚

`ReadWriteLock` æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface ReadWriteLock {
    Lock readLock();
    Lock writeLock();
}
```

- `readLock` - è¿”å›ç”¨äºè¯»æ“ä½œçš„é”ï¼ˆ`ReadLock`ï¼‰ã€‚
- `writeLock` - è¿”å›ç”¨äºå†™æ“ä½œçš„é”ï¼ˆ`WriteLock`ï¼‰ã€‚

åœ¨è¯»å†™é”å’Œå†™å…¥é”ä¹‹é—´çš„äº¤äº’å¯ä»¥é‡‡ç”¨å¤šç§å®ç°æ–¹å¼ï¼Œ`ReadWriteLock` çš„ä¸€äº›å¯é€‰å®ç°åŒ…æ‹¬ï¼š

- **é‡Šæ”¾ä¼˜å…ˆ** - å½“ä¸€ä¸ªå†™å…¥æ“ä½œé‡Šæ”¾å†™é”ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¸­åŒæ—¶å­˜åœ¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹ï¼Œé‚£ä¹ˆåº”è¯¥ä¼˜å…ˆé€‰æ‹©è¯»çº¿ç¨‹ã€å†™çº¿ç¨‹ï¼Œè¿˜æ˜¯æœ€å…ˆå‘å‡ºè¯·æ±‚çš„çº¿ç¨‹ï¼Ÿ
- **è¯»çº¿ç¨‹æ’é˜Ÿ** - å¦‚æœé”æ˜¯ç”±è¯»çº¿ç¨‹æŒæœ‰ï¼Œä½†æœ‰å†™çº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆæ–°åˆ°è¾¾çš„è¯»çº¿ç¨‹èƒ½å¦ç«‹å³è·å¾—è®¿é—®æƒï¼Œè¿˜æ˜¯åº”è¯¥åœ¨å†™çº¿ç¨‹åé¢ç­‰å¾…ï¼Ÿå¦‚æœå…è®¸è¯»çº¿ç¨‹æ’é˜Ÿåˆ°å†™çº¿ç¨‹ä¹‹å‰ï¼Œé‚£ä¹ˆå°†æé«˜å¹¶å‘æ€§ï¼Œä½†å¯èƒ½é€ æˆçº¿ç¨‹é¥¥é¥¿é—®é¢˜ã€‚
- **é‡å…¥æ€§** - è¯»é”å’Œå†™é”æ˜¯å¦æ˜¯å¯é‡å…¥çš„ï¼Ÿ
- **é™çº§** - å¦‚æœä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™å…¥é”ï¼Œé‚£ä¹ˆå®ƒèƒ½å¦åœ¨ä¸é‡Šæ”¾è¯¥é”çš„æƒ…å†µä¸‹è·å¾—è¯»é”ï¼Ÿè¿™å¯èƒ½ä¼šä½¿å¾—å†™é”è¢«é™çº§ä¸ºè¯»é”ï¼ŒåŒæ—¶ä¸å…è®¸å…¶ä»–å†™çº¿ç¨‹ä¿®æ”¹è¢«ä¿æŠ¤çš„èµ„æºã€‚
- **å‡çº§** - è¯»é”èƒ½å¦ä¼˜å…ˆäºå…¶ä»–æ­£åœ¨ç­‰å¾…çš„è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹è€Œå‡çº§ä¸ºä¸€ä¸ªå†™é”ï¼Ÿåœ¨å¤§å¤šæ•°çš„è¯»å†™é”å®ç°ä¸­å¹¶ä¸æ”¯æŒå‡çº§ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰æ˜¾å¼çš„å‡çº§æ“ä½œï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“é€ æˆæ­»é”ã€‚

## 4.2. `ReentrantReadWriteLock` çš„ç”¨æ³•åŠåŸç†

åœ¨AQSä¸­åªç»´æŠ¤äº†ä¸€ä¸ª`state`çŠ¶æ€, è€Œ`ReentrantReadWriteLock`åˆ™éœ€è¦ç»´æŠ¤è¯»çŠ¶æ€å’Œå†™çŠ¶æ€.å®ƒå·§å¦™çš„ç”¨`state`çš„é«˜16ä½è¡¨ç¤ºè¯»çŠ¶æ€, ä¹Ÿå°±æ˜¯è·å–åˆ°è¯»é”çš„æ¬¡æ•°, ç”¨ä½16ä½è¡¨ç¤ºè·å–åˆ°å†™é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°.

```java
static final int SHARED_SHIFT   = 16;
// å…±äº«é”(è¯»é”)çŠ¶æ€çš„å•ä½å€¼65536
static final int SHARED_UNIT    = (1 << SHARED_SHIFT);
// å…±äº«é”çº¿ç¨‹æœ€å¤§ä¸ªæ•°65535
static final int MAX_COUNT      = (1 << SHARED_SHIFT) - 1;
// æ’ä»–é”(å†™é”)æ©ç , äºŒè¿›åˆ¶, 15ä¸ª1
static final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;
// è¿”å›è¯»çº¿ç¨‹æ•°
static int sharedCount(int c)    { return c >>> SHARED_SHIFT; }
// è¿”å›å†™é”å¯é‡å…¥ä¸ªæ•°
static int exclusiveCount(int c) { return c & EXCLUSIVE_MASK; }
```



### `ReentrantReadWriteLock` çš„æ„é€ æ–¹æ³•

`ReentrantReadWriteLock` å’Œ `ReentrantLock` ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œä¸”ç”¨æ³•ç›¸ä¼¼ã€‚

```java
public ReentrantReadWriteLock() {
    this(false);
}

public ReentrantReadWriteLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
    readerLock = new ReadLock(this);
    writerLock = new WriteLock(this);
}
```

- `ReentrantReadWriteLock()` - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ª**éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰**ã€‚åœ¨éå…¬å¹³çš„é”ä¸­ï¼Œçº¿ç¨‹è·å¾—é”çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚å†™çº¿ç¨‹é™çº§ä¸ºè¯»çº¿ç¨‹æ˜¯å¯ä»¥çš„ï¼Œä½†è¯»çº¿ç¨‹å‡çº§ä¸ºå†™çº¿ç¨‹æ˜¯ä¸å¯ä»¥çš„ï¼ˆè¿™æ ·ä¼šå¯¼è‡´æ­»é”ï¼‰ã€‚
- `ReentrantReadWriteLock(boolean)` - `new ReentrantLock(true)` ä¼šåˆå§‹åŒ–ä¸€ä¸ª**å…¬å¹³é”ï¼ˆFairSyncï¼‰**ã€‚å¯¹äºå…¬å¹³é”ï¼Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹å°†ä¼˜å…ˆè·å¾—é”ã€‚å¦‚æœè¿™ä¸ªé”æ˜¯è¯»çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å¦ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™é”ï¼Œé‚£ä¹ˆå…¶ä»–è¯»çº¿ç¨‹éƒ½ä¸èƒ½è·å¾—è¯»é”ï¼Œç›´åˆ°å†™çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚

### å†™é”çš„è·å–ä¸é‡Šæ”¾

#### `void lock()`æ–¹æ³•

```java
public void lock() {
    sync.acquire(1);
}

public final void acquire(long arg) {
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

è°ƒç”¨äº†AQSçš„`acquire`æ–¹æ³•, å…¶ä¸­`tryAcquire`æ˜¯`ReentrantReadWriteLock`å†…éƒ¨`sync`ç±»é‡å†™: 

```java
protected final boolean tryAcquire(int acquires) {
    Thread current = Thread.currentThread();
    int c = getState();
    int w = exclusiveCount(c);	// cä¸16ä½1ç›¸ä¸
    // (1) c != 0è¯´æ˜è¯»é”æˆ–è€…å†™é”å·²ç»è¢«æŸçº¿ç¨‹è·å–
    if (c != 0) {
        // (2) w = 0 è¯´æ˜å·²ç»æœ‰çº¿ç¨‹è·å–äº†è¯»é”, w != 0å¹¶ä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”æ‹¥æœ‰è€…, åˆ™è¿”å›false
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        // (3) è¯´æ˜å½“å‰çº¿ç¨‹è·å–äº†å†™é”, åˆ¤æ–­å¯é‡å…¥æ¬¡æ•°
        if (w + exclusiveCount(acquires) > MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
        // Reentrant acquire
        // (4)è®¾ç½®å¯é‡å…¥æ¬¡æ•°
        setState(c + acquires);
        return true;
    }
    // (5)ç¬¬ä¸€ä¸ªå†™çº¿ç¨‹è·å–å†™é”
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    setExclusiveOwnerThread(current);
    return true;
}
```

åœ¨ä»£ç (1)ä¸­, å¦‚æœå½“å‰AQSçŠ¶æ€å€¼ä¸ä¸º0åˆ™è¯´æ˜å½“å‰å·²ç»æœ‰çº¿ç¨‹è·å–åˆ°äº†è¯»é”æˆ–è€…å†™é”. åœ¨(2)ä¸­, å¦‚æœ`w == 0`åˆ™è¯´æ˜çŠ¶æ€å€¼ä½16ä½ä½0, è€ŒAQSçŠ¶æ€å€¼ä¸ä¸º0, åˆ™è¯´æ˜é«˜16ä½ä¸ä¸º0, è¿™æš—ç¤ºå·²ç»æœ‰çº¿ç¨‹è·å–äº†è¯»é”, æ‰€ä»¥ç›´æ¥è¿”å›`false`.

è€Œå¦‚æœ`w != 0`åˆ™è¯´æ˜å½“å‰å·²ç»æœ‰çº¿ç¨‹è·å–åˆ°äº†è¯¥å†™é”, å†çœ‹å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯è¯¥å†™é”çš„æŒæœ‰è€…, å¦‚æœä¸æ˜¯åˆ™è¿”å›`false`

æ‰§è¡Œåˆ°(3)è¯´æ˜å½“å‰çº¿ç¨‹ä¹‹å‰å·²ç»è·å–åˆ°äº†è¯¥é”, æ‰€ä»¥åˆ¤æ–­è¯¥çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°æ˜¯ä¸æ˜¯è¶…è¿‡äº†æœ€å¤§å€¼, æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸, éƒ½åœ¨æ‰§è¡Œ(4)å¤„ä»£ç å¢åŠ å½“å‰çº¿ç¨‹å¯é‡å…¥æ¬¡æ•°, ç„¶åè¿”å›`true`

å¦‚æœAQSçš„çŠ¶æ€å€¼ç­‰äº0åˆ™è¯´æ˜ç›®å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°è¯»é”å’Œå†™é”, æ‰€ä»¥æ‰§è¡Œä»£ç (5). å…¶ä¸­, å¯¹äº`writeShouldBlock`æ–¹æ³•, éå…¬å¹³é”çš„å®ç°ä¸º: 

```java
final boolean writerShouldBlock() {
    return false; // writers can always barge
}
```

å¦‚æœä»£ç å¯¹äºéå…¬å¹³é”æ¥è¯´æ€»æ˜¯è¿”å›`false`, åˆ™è¯´æ˜å¸¦å•Šå—(5)æŠ¢å å¼æ‰§è¡ŒCASå°è¯•è·å–å†™é”, è·å–æˆåŠŸåˆ™è®¾ç½®å½“å‰é”çš„æŒæœ‰è€…ä¸ºå½“å‰çº¿ç¨‹å¹¶è¿”å›`true`, å¦åˆ™è¿”å›`false`.

å…¬å¹³é”çš„å®ç°ä¸º:

```java
final boolean writerShouldBlock() {
    return hasQueuedPredecessors();
}
```

è¿˜æ˜¯ä½¿ç”¨`hasQueuedPredecessors`æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, å¦‚æœæœ‰åˆ™å½“å‰çº¿ç¨‹æ”¾å¼ƒè·å–å†™é”çš„æƒé™, ç›´æ¥è¿”å›`false`

#### `void lockInterruptibly()`æ–¹æ³•

ä¸`ReentrantLock`ä¸­æ–¹æ³•ä¸€è‡´

è¯¥æ–¹æ³•ä¸`lock()`æ–¹æ³•ç±»ä¼¼, ä¸åŒä¹‹å¤„åœ¨äº, å®ƒèƒ½ä¸­æ–­è¿›è¡Œå“åº”, å°±æ˜¯å½“å‰çº¿ç¨‹åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶, å¦‚æœå…¶å®ƒçº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„`interrupt()`æ–¹æ³•, åˆ™å½“å‰çº¿ç¨‹ä¼šæŠ›å‡º`InterruptedException`å¼‚å¸¸. æºç åœ¨AQSåŒ…ä¸­.

```java
public void lockInterruptibly() throws InterruptedException {
    sync.acquireInterruptibly(1);
}
```

#### `boolean tryLock()`æ–¹æ³•

å°è¯•è·å–å†™é”. ç”¨æ³•å’Œ`ReentrantLock`ä¸­ç±»ä¼¼.

```java
public boolean tryLock( ) {
    return sync.tryWriteLock();
}

final boolean tryWriteLock() {
    Thread current = Thread.currentThread();
    int c = getState();
    if (c != 0) {
        int w = exclusiveCount(c);
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        if (w == MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
    }
    if (!compareAndSetState(c, c + 1))
        return false;
    setExclusiveOwnerThread(current);
    return true;
}
```

ä¸`tryAcquire`æ–¹æ³•ç±»ä¼¼, ä¸åŒåœ¨äºè¿™é‡Œä½¿ç”¨çš„æ˜¯éå…¬å¹³é”ç­–ç•¥.

è¿˜æœ‰ä¸€ä¸ª`boolean tryLock(long timeout, TimeUnit unit)`æ–¹æ³•. å°è¯•è·å–å†™é”å¤±è´¥åˆ™ä¼šæŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·æŒ‡å®šæ—¶é—´, å¾…è¶…æ—¶æ—¶é—´åˆ°åå½“å‰çº¿ç¨‹è¢«æ¿€æ´», å¦‚æœè¿˜æ˜¯æ²¡æœ‰è·å–åˆ°å†™é”åˆ™è¿”å›`false`. å¦å¤–, è¯¥æ–¹æ³•ä¼šå¯¹ä¸­æ–­è¿›è¡Œå“åº”.

```java
public boolean tryLock(long timeout, TimeUnit unit)
    throws InterruptedException {
    return sync.tryAcquireNanos(1, unit.toNanos(timeout));
}
```

#### `void unlock()`æ–¹æ³•

å’Œ`ReentrantLokc`æ–¹æ³•ç”¨æ³•ç±»ä¼¼.

```java
public void unlock() {
    sync.release(1);	// AQSä¸­çš„release
}

public final boolean release(long arg) {
    // è°ƒç”¨ReentrantReadWriteLockä¸­syncå®ç°çš„tryReleaseæ–¹æ³•
    if (tryRelease(arg)) {
        // æ¿€æ´»é˜»å¡é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}

protected final boolean tryRelease(int releases) {
    // (6)çœ‹æ˜¯å¦æ˜¯å†™é”æ‹¥æœ‰è€…è°ƒç”¨çš„unlock
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    // (7)è·å–å¯é‡å…¥å€¼,è¿™é‡Œæ²¡æœ‰è€ƒè™‘é«˜16ä½, å› ä¸ºè·å–å†™é”æ—¶è¯»é”çŠ¶æ€å€¼è‚¯å®šä¸º0
    int nextc = getState() - releases;
    boolean free = exclusiveCount(nextc) == 0;
    // (8)å¦‚æœå†™é”å¯é‡å…¥å€¼ä¸º0åˆ™é‡Šæ”¾é”, å¦åˆ™åªæ˜¯ç®€å•åœ°æ›´æ–°çŠ¶æ€å€¼
    if (free)
        setExclusiveOwnerThread(null);
    setState(nextc);
    return free;
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­,`tryRelease`é¦–å…ˆé€šè¿‡`isHeldExclusively`åˆ¤æ–­æ˜¯å¦å½“å‰çº¿ç¨‹æ—¶è¯¥å†™é”çš„æŒæœ‰è€…, å¦‚æœä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸, å¦åˆ™æ‰§è¡Œä»£ç (7), è¿™è¯´æ˜å½“å‰çº¿ç¨‹æŒæœ‰å†™é”, æŒæœ‰å†™é”è¯´æ˜çŠ¶æ€å€¼çš„é«˜16ä½ä¸º0, æ‰€ä»¥è¿™é‡Œ`nextc`å€¼å°±æ˜¯å½“å‰çº¿ç¨‹å†™é”çš„å‰©ä½™å¯é‡å…¥æ¬¡æ•°. ä»£ç (8)åˆ¤æ–­å½“å‰å¯é‡å…¥æ¬¡æ•°æ˜¯å¦ä¸º0, å¦‚æœ`free`ä¸º`true`åˆ™è¯´æ˜å¯é‡å…¥æ¬¡æ•°ä¸º0, æ‰€ä»¥å½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾å†™é”, å°†å½“å‰é”çš„æŒæœ‰è€…è®¾ç½®ä¸º`null`.å¦‚æœ`free`ä¸º`false`åˆ™ç®€å•åœ°æ›´æ–°å¯é‡å…¥æ¬¡æ•°.

### è¯»é”çš„è·å–ä¸é‡Šæ”¾

#### `void lock()`æ–¹æ³•

è·å–è¯»é”, å¦‚æœå½“å‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, åˆ™å½“å‰çº¿ç¨‹å¯ä»¥è·å–è¯»é”, AQSçš„çŠ¶æ€å€¼`state`çš„é«˜16ä½ä¼šåŠ 1, ç„¶åæ–¹æ³•è¿”å›. å¦åˆ™å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, åˆ™å½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡.

```java
public void lock() {
    sync.acquireShared(1);	// è°ƒç”¨AQSä¸­çš„æ–¹æ³•
}

public final void acquireShared(long arg) {
    // è°ƒç”¨ReentrantReadWriteLockä¸­çš„syncçš„tryAcquireSharedæ–¹æ³•
    if (tryAcquireShared(arg) < 0)
        // è°ƒç”¨AQSä¸­çš„æ–¹æ³•
        doAcquireShared(arg);
}

// ReentrantReadWriteLockä¸­çš„syncçš„tryAcquireSharedæ–¹æ³•
protected final int tryAcquireShared(int unused) {
    // (1)è·å–å½“å‰çŠ¶æ€å€¼
    Thread current = Thread.currentThread();
    int c = getState();
    
    // (2)åˆ¤æ–­æ˜¯å¦å†™é”è¢«å ç”¨: ä½16ä½ä¸16ä½1ç›¸ä¸åæ˜¯å¦ä¸ä¸º0
    if (exclusiveCount(c) != 0 &&
        getExclusiveOwnerThread() != current)
        return -1;
    // (3)è·å–è¯»é”è®¡æ•°
    int r = sharedCount(c);
    // (4)å°è¯•è·å–é”,å¤šä¸ªè¯»çº¿ç¨‹åªæœ‰ä¸€ä¸ªä¼šæˆåŠŸ,ä¸æˆåŠŸçš„è¿›å…¥fullTryAcquireSharedè¿›è¡Œé‡è¯•
    if (!readerShouldBlock() &&
        r < MAX_COUNT &&
        compareAndSetState(c, c + SHARED_UNIT)) {
        // (5)ç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–è¯»é”
        if (r == 0) {
            firstReader = current;
            firstReaderHoldCount = 1;
        // (6)å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
        } else if (firstReader == current) {
            firstReaderHoldCount++;
        } else {
            // (7)è®°å½•æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹æˆ–è®°å½•å…¶å®ƒçº¿ç¨‹è¯»é”çš„å¯é‡å…¥æ•°
            HoldCounter rh = cachedHoldCounter;
            if (rh == null || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            else if (rh.count == 0)
                readHolds.set(rh);
            rh.count++;
        }
        return 1;
    }
    // (8)ç±»ä¼¼tryAcquireShared, ä½†æ˜¯æ˜¯è‡ªæ—‹è·å–
    return fullTryAcquireShared(current);
}
```

å¦‚ä¸Šä»£ç å…ˆè·å–å½“å‰AQSçš„çŠ¶æ€å€¼, ç„¶åä»£ç (2)æŸ¥çœ‹æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹è·å–åˆ°å†™é”. å¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›-1, è€Œåè°ƒç”¨AQSçš„`doAcquireShared`æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ”¾å…¥AQSé˜»å¡é˜Ÿåˆ—.

å¦‚æœ**å½“å‰è¦è·å–è¯»é”çš„è¿›ç¨‹å·²ç»æŒæœ‰äº†å†™é”, åˆ™ä¹Ÿå¯ä»¥è·å–è¯»é”**. ä½†æ˜¯è¦æ³¨æ„, å½“ä¸€ä¸ªè¿›ç¨‹å…ˆè·å–äº†å†™é”, ç„¶åè·å–äº†è¯»é”å¤„ç†äº‹æƒ…å®Œæ¯•å, è¦è®°å¾—æŠŠè¯»é”å’Œå†™é”éƒ½é‡Šæ”¾æ‰, ä¸èƒ½åªé‡Šæ”¾å†™é”.

å¦åˆ™æ‰§è¡Œä»£ç (3), å¾—åˆ°è·å–åˆ°çš„è¯»é”çš„ä¸ªæ•°, åˆ°è¿™é‡Œè¯´æ˜ç›®å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°å†™é”, ä½†æ˜¯å¯èƒ½æœ‰çº¿ç¨‹æŒæœ‰è¯»é”, ç„¶åæ‰§è¡Œä»£ç (4).å…¶ä¸­éå…¬å¹³é”çš„`readerShouldBlock`å®ç°ä»£ç å¦‚ä¸‹:

```java
final boolean readerShouldBlock() {
    return apparentlyFirstQueuedIsExclusive();
}

final boolean apparentlyFirstQueuedIsExclusive() {
    Node h, s;
    return (h = head) != null &&
        (s = h.next)  != null &&
        !s.isShared()         &&
        s.thread != null;
}
```

ä¸Šé¢ä»£ç çš„ä½œç”¨æ˜¯, å¦‚æœé˜Ÿåˆ—é‡Œé¢å­˜åœ¨ä¸€ä¸ªå…ƒç´ , åˆ™åˆ¤æ–­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯æ­£åœ¨å°è¯•è·å–å†™é”, å¦‚æœä¸æ˜¯, åˆ™å½“å‰çº¿ç¨‹åˆ¤æ–­å½“å‰è·å–è¯»é”çš„çº¿ç¨‹æ˜¯å¦è¾¾åˆ°äº†æœ€å¤§å€¼. æœ€åæ‰§è¡ŒCASæ“ä½œå°†AQSçŠ¶æ€å€¼çš„é«˜16ä½å€¼å¢åŠ 1.

ä»£ç (5)(6)è®°å½•ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹å¹¶ç»Ÿè®¡è¯¥çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ•°.ä»£ç (7)ä½¿ç”¨`cachedHoldCounter`è®°å½•æœ€åä¸€ä¸ªè·å–åˆ°è¯»é”çš„çº¿ç¨‹å’Œè¯¥çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ•°, `readHolds`è®°å½•äº†å½“å‰çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ•°.

å¦‚æœ`readerShouldBlock`è¿”å›`true`åˆ™è¯´æ˜æœ‰çº¿ç¨‹æ­£åœ¨è·å–å†™é”, æ‰€ä»¥æ‰§è¡Œ(8)å¤„ä»£ç ,` fullTryAcquireShared`çš„ä»£ç ä¸`tryAcquireShared`ç±»ä¼¼, å®ƒä»¬çš„ä¸åŒä¹‹å¤„åœ¨äº, å‰è€…é€šè¿‡å¾ªç¯è‡ªæ—‹è·å–.

#### `void lockInterruptibly()`æ–¹æ³•

ä¸ä¹‹å‰è®²è¿°çš„ç±»ä¼¼

#### `void tryLock()`æ–¹æ³•

å°è¯•è·å–è¯»é”, å¦‚æœå½“å‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, åˆ™ä¼šæˆåŠŸè·å–è¯»é”, è¿”å›`true`. å¦åˆ™è¿”å›`false`, ä½†å½“å‰çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡..

å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥è¯»é”, åˆ™ç®€å•çš„å¢åŠ AQSçš„çŠ¶æ€å€¼é«˜16ä½,ç„¶åè¿”å›`true`

è¿˜æœ‰ä¸€ä¸ª`boolean tryLock(long timeout, TimeUnit unit)`æ–¹æ³•. æºç å’Œå‰é¢ä»£ç ç±»ä¼¼.

#### `void unlock()`æ–¹æ³•

```java
public void unlock() {
    sync.releaseShared(1);
}

public final boolean releaseShared(long arg) {
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}

protected final boolean tryReleaseShared(int unused) {
    Thread current = Thread.currentThread();
    if (firstReader == current) {
        // assert firstReaderHoldCount > 0;
        if (firstReaderHoldCount == 1)
            firstReader = null;
        else
            firstReaderHoldCount--;
    } else {
        HoldCounter rh = cachedHoldCounter;
        if (rh == null || rh.tid != getThreadId(current))
            rh = readHolds.get();
        int count = rh.count;
        if (count <= 1) {
            readHolds.remove();
            if (count <= 0)
                throw unmatchedUnlockException();
        }
        --rh.count;
    }
    // å¾ªç¯ç›´åˆ°è‡ªå·±çš„è¯»è®¡æ•°-1, CASæ›´æ–°æˆåŠŸ
    for (;;) {
        int c = getState();
        int nextc = c - SHARED_UNIT;
        if (compareAndSetState(c, nextc))
            // Releasing the read lock has no effect on readers,
            // but it may allow waiting writers to proceed if
            // both read and write locks are now free.
            return nextc == 0;
    }
}
```

åœ¨æ— é™å¾ªç¯é‡Œé¢, é¦–å…ˆè·å–å½“å‰AQSçŠ¶æ€å€¼å¹¶å°†å…¶ä¿å­˜åˆ°å˜é‡c, ç„¶åå˜é‡cè¢«å‡å»ä¸€ä¸ªè¯»è®¡æ•°å•ä½åä½¿ç”¨CASæ“ä½œæ›´æ–°AQSçš„çŠ¶æ€å€¼, å¦‚æœæ›´æ–°æˆåŠŸåˆ™æŸ¥çœ‹å½“å‰AQSçŠ¶æ€å€¼æ˜¯å¦ä½0, ä¸º0åˆ™è¯´æ˜å½“å‰å·²ç»æ²¡æœ‰è¯»çº¿ç¨‹å ç”¨è¯»é”, åˆ™`tryReleaseShared`è¿”å›`true`.ç„¶åè°ƒç”¨`doReleaseShared`æ–¹æ³•é‡Šæ”¾ä¸€ä¸ªç”±äºè·å–å†™é”è€Œè¢«é˜»å¡çš„çº¿ç¨‹, å¦‚æœå½“å‰AQSçŠ¶æ€å€¼ä¸ä¸º0, åˆ™è¯´æ˜å½“å‰è¿˜æœ‰å…¶å®ƒçº¿ç¨‹æŒæœ‰äº†è¯»é”, æ‰€ä»¥è¿”å›`false`. å¦‚æœ`tryReleaseShared`ä¸­çš„CASæ›´æ–°AQSçŠ¶æ€å€¼å¤±è´¥, åˆ™è‡ªæ—‹é‡è¯•ç›´åˆ°æˆåŠŸ.

# 5. `StampedLock`

`ReadWriteLock` æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šä¸€ç§æ˜¯è¯»é”ï¼Œä¸€ç§æ˜¯å†™é”ã€‚

è€Œ `StampedLock` æ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š**å†™é”**ã€**æ‚²è§‚è¯»é”**å’Œ**ä¹è§‚è¯»**ã€‚å…¶ä¸­ï¼Œå†™é”ã€æ‚²è§‚è¯»é”çš„è¯­ä¹‰å’Œ `ReadWriteLock` çš„å†™é”ã€è¯»é”çš„è¯­ä¹‰éå¸¸ç±»ä¼¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–æ‚²è§‚è¯»é”ï¼Œä½†æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”ï¼Œå†™é”å’Œæ‚²è§‚è¯»é”æ˜¯äº’æ–¥çš„ã€‚ä¸åŒçš„æ˜¯ï¼š`StampedLock` é‡Œçš„å†™é”å’Œæ‚²è§‚è¯»é”åŠ é”æˆåŠŸä¹‹åï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ª `stamp`ï¼›ç„¶åè§£é”çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥è¿™ä¸ª `stamp`ã€‚

> æ³¨æ„è¿™é‡Œï¼Œç”¨çš„æ˜¯â€œä¹è§‚è¯»â€è¿™ä¸ªè¯ï¼Œè€Œä¸æ˜¯â€œä¹è§‚è¯»é”â€ï¼Œæ˜¯è¦æé†’ä½ ï¼Œ**ä¹è§‚è¯»è¿™ä¸ªæ“ä½œæ˜¯æ— é”çš„**ï¼Œæ‰€ä»¥ç›¸æ¯”è¾ƒ ReadWriteLock çš„è¯»é”ï¼Œä¹è§‚è¯»çš„æ€§èƒ½æ›´å¥½ä¸€äº›ã€‚

`StampedLock` çš„æ€§èƒ½ä¹‹æ‰€ä»¥æ¯” `ReadWriteLock `è¿˜è¦å¥½ï¼Œå…¶å…³é”®æ˜¯**StampedLock æ”¯æŒä¹è§‚è¯»**çš„æ–¹å¼ã€‚

- `ReadWriteLock` æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†æ˜¯å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å†™æ“ä½œä¼šè¢«é˜»å¡ï¼›
- è€Œ `StampedLock` æä¾›çš„ä¹è§‚è¯»ï¼Œæ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ‰€æœ‰çš„å†™æ“ä½œéƒ½è¢«é˜»å¡ã€‚

å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯ `StampedLock` æ€§èƒ½å¾ˆå¥½ï¼Œç®€å•çš„åº”ç”¨åœºæ™¯åŸºæœ¬ä¸Šå¯ä»¥æ›¿ä»£ `ReadWriteLock`ï¼Œä½†æ˜¯**StampedLock çš„åŠŸèƒ½ä»…ä»…æ˜¯ ReadWriteLock çš„å­é›†**ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚

- **StampedLock ä¸æ”¯æŒé‡å…¥**
- `StampedLock` çš„æ‚²è§‚è¯»é”ã€å†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ã€‚
- å¦‚æœçº¿ç¨‹é˜»å¡åœ¨`` StampedLock` çš„ `readLock() `æˆ–è€… `writeLock() `ä¸Šæ—¶ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥é˜»å¡çº¿ç¨‹çš„ `interrupt()`` æ–¹æ³•ï¼Œä¼šå¯¼è‡´ CPU é£™å‡ã€‚**ä½¿ç”¨ StampedLock ä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é” readLockInterruptibly() å’Œå†™é” writeLockInterruptibly()**ã€‚

# 6. æŠ½è±¡åŒæ­¥é˜Ÿåˆ—AQSæ¦‚è¿°

> `AbstractQueuedSynchronizer`ï¼ˆç®€ç§° **AQS**ï¼‰æ˜¯**é˜Ÿåˆ—åŒæ­¥å™¨**ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¤„ç†åŒæ­¥ã€‚å®ƒæ˜¯å¹¶å‘é”å’Œå¾ˆå¤šåŒæ­¥å·¥å…·ç±»çš„å®ç°åŸºçŸ³ï¼ˆå¦‚ `ReentrantLock`ã€`ReentrantReadWriteLock`ã€`CountDownLatch`ã€`Semaphore`ã€`FutureTask` ç­‰ï¼‰ã€‚

## 6.1. AQS çš„è¦ç‚¹

**AQS æä¾›äº†å¯¹ç‹¬äº«é”ä¸å…±äº«é”çš„æ”¯æŒ**ã€‚

åœ¨ `java.util.concurrent.locks` åŒ…ä¸­çš„ç›¸å…³é”ï¼ˆå¸¸ç”¨çš„æœ‰ `ReentrantLock`ã€ `ReadWriteLock`ï¼‰éƒ½æ˜¯åŸºäº AQS æ¥å®ç°ã€‚è¿™äº›é”éƒ½æ²¡æœ‰ç›´æ¥ç»§æ‰¿ AQSï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ª `Sync` ç±»å»ç»§æ‰¿ AQSã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿå› ä¸ºé”é¢å‘çš„æ˜¯ä½¿ç”¨ç”¨æˆ·ï¼Œè€ŒåŒæ­¥å™¨é¢å‘çš„åˆ™æ˜¯çº¿ç¨‹æ§åˆ¶ï¼Œé‚£ä¹ˆåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨è€Œä¸æ˜¯ç›´æ¥ç»§æ‰¿ AQS å°±å¯ä»¥å¾ˆå¥½çš„éš”ç¦»äºŒè€…æ‰€å…³æ³¨çš„äº‹æƒ…ã€‚

## 6.2. AQS çš„åº”ç”¨

**AQS æä¾›äº†å¯¹ç‹¬äº«é”ä¸å…±äº«é”çš„æ”¯æŒ**ã€‚

### ç‹¬äº«é” API

è·å–ã€é‡Šæ”¾ç‹¬äº«é”çš„ä¸»è¦ API å¦‚ä¸‹ï¼š

```java
public final void acquire(int arg)
public final void acquireInterruptibly(int arg)
public final boolean tryAcquireNanos(int arg, long nanosTimeout)
public final boolean release(int arg)
```

- `acquire` - è·å–ç‹¬å é”ã€‚

- `acquireInterruptibly` - è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚

- ```
  tryAcquireNanos
  ```

   

  \- å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹å›è¿”å›ï¼š

  - åœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œå½“å‰çº¿ç¨‹æˆåŠŸè·å–äº†é”ï¼›
  - å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ï¼›
  - è¶…æ—¶æ—¶é—´ç»“æŸï¼Œä»æœªè·å¾—é”è¿”å› falseã€‚

- `release` - é‡Šæ”¾ç‹¬å é”ã€‚

### å…±äº«é” API

è·å–ã€é‡Šæ”¾å…±äº«é”çš„ä¸»è¦ API å¦‚ä¸‹ï¼š

```java
public final void acquireShared(int arg)
public final void acquireSharedInterruptibly(int arg)
public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)
public final boolean releaseShared(int arg)
```

- `acquireShared` - è·å–å…±äº«é”ã€‚
- `acquireSharedInterruptibly` - è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚
- `tryAcquireSharedNanos` - å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚
- `release` - é‡Šæ”¾å…±äº«é”

## 6.3. AQS çš„åŸç†

> ASQ åŸç†è¦ç‚¹ï¼š
>
> - AQS ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ `volatile` å˜é‡æ¥ **ç»´æŠ¤åŒæ­¥çŠ¶æ€**ã€‚çŠ¶æ€çš„æ„ä¹‰ç”±å­ç±»èµ‹äºˆã€‚
> - AQS ç»´æŠ¤äº†ä¸€ä¸ª FIFO çš„åŒé“¾è¡¨ï¼Œç”¨æ¥å­˜å‚¨è·å–é”å¤±è´¥çš„çº¿ç¨‹ã€‚
>
> AQS å›´ç»•åŒæ­¥çŠ¶æ€æä¾›ä¸¤ç§åŸºæœ¬æ“ä½œâ€œè·å–â€å’Œâ€œé‡Šæ”¾â€ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—åˆ¤æ–­å’Œå¤„ç†æ–¹æ³•ï¼Œç®€å•è¯´å‡ ç‚¹ï¼š
>
> - state æ˜¯ç‹¬å çš„ï¼Œè¿˜æ˜¯å…±äº«çš„ï¼›
> - state è¢«è·å–åï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼›
> - state è¢«é‡Šæ”¾åï¼Œå”¤é†’ç­‰å¾…çº¿ç¨‹ï¼›
> - çº¿ç¨‹ç­‰ä¸åŠæ—¶ï¼Œå¦‚ä½•é€€å‡ºç­‰å¾…ã€‚
>
> è‡³äºçº¿ç¨‹æ˜¯å¦å¯ä»¥è·å¾— stateï¼Œå¦‚ä½•é‡Šæ”¾ stateï¼Œå°±ä¸æ˜¯ AQS å…³å¿ƒçš„äº†ï¼Œè¦ç”±å­ç±»å…·ä½“å®ç°ã€‚

### AQS çš„æ•°æ®ç»“æ„

é˜…è¯» AQS çš„æºç ï¼Œå¯ä»¥å‘ç°ï¼šAQS ç»§æ‰¿è‡ª `AbstractOwnableSynchronize`ã€‚

```java
public abstract class AbstractQueuedSynchronizer
    extends AbstractOwnableSynchronizer
    implements java.io.Serializable {

    /** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå¤´ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ setHead æ–¹æ³•ä¿®æ”¹ã€‚ */
    private transient volatile Node head;
    /** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ enq æ–¹æ³•æ·»åŠ æ–°çš„ç­‰å¾…èŠ‚ç‚¹ã€‚*/
    private transient volatile Node tail;
    /** åŒæ­¥çŠ¶æ€ */
    private volatile int state;
}
```

- `state` - AQS ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ `volatile` å˜é‡æ¥ **ç»´æŠ¤åŒæ­¥çŠ¶æ€**ã€‚
  - è¿™ä¸ªæ•´æ•°çŠ¶æ€çš„æ„ä¹‰ç”±å­ç±»æ¥èµ‹äºˆï¼Œå¦‚`ReentrantLock` ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºæ‰€æœ‰è€…çº¿ç¨‹å·²ç»é‡å¤è·å–è¯¥é”çš„æ¬¡æ•°ï¼Œ`Semaphore` ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºå‰©ä½™çš„è®¸å¯æ•°é‡ã€‚
- `head` å’Œ `tail` - AQS **ç»´æŠ¤äº†ä¸€ä¸ª `Node` ç±»å‹ï¼ˆAQS çš„å†…éƒ¨ç±»ï¼‰çš„åŒé“¾è¡¨æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†**ã€‚è¿™ä¸ªåŒé“¾è¡¨æ˜¯ä¸€ä¸ªåŒå‘çš„ FIFO é˜Ÿåˆ—ï¼Œé€šè¿‡ `head` å’Œ `tail` æŒ‡é’ˆè¿›è¡Œè®¿é—®ã€‚å½“ **æœ‰çº¿ç¨‹è·å–é”å¤±è´¥åï¼Œå°±è¢«æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾**ã€‚

å†æ¥çœ‹ä¸€ä¸‹ `Node` çš„æºç 

```java
static final class Node {
    /** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºå…±äº«æ¨¡å¼ */
    static final Node SHARED = new Node();
    /** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºç‹¬å æ¨¡å¼ */
    static final Node EXCLUSIVE = null;

    /** çº¿ç¨‹ç­‰å¾…çŠ¶æ€ï¼ŒçŠ¶æ€å€¼æœ‰: 0ã€1ã€-1ã€-2ã€-3 */
    volatile int waitStatus;
    static final int CANCELLED =  1;
    static final int SIGNAL    = -1;
    static final int CONDITION = -2;
    static final int PROPAGATE = -3;

    /** å‰é©±èŠ‚ç‚¹ */
    volatile Node prev;
    /** åç»§èŠ‚ç‚¹ */
    volatile Node next;
    /** ç­‰å¾…é”çš„çº¿ç¨‹ */
    volatile Thread thread;

  	/** å’ŒèŠ‚ç‚¹æ˜¯å¦å…±äº«æœ‰å…³ */
    Node nextWaiter;
}
```

å¾ˆæ˜¾ç„¶ï¼ŒNode æ˜¯ä¸€ä¸ªåŒé“¾è¡¨ç»“æ„ã€‚

- `waitStatus` - `Node` ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ `volatile` å˜é‡æ¥ ç»´æŠ¤ AQS åŒæ­¥é˜Ÿåˆ—ä¸­çº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ã€‚`waitStatus` æœ‰äº”ä¸ªçŠ¶æ€å€¼ï¼š
  - `CANCELLED(1)` - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹å¯èƒ½ç”±äºè¶…æ—¶æˆ–è¢«ä¸­æ–­è€Œ **å¤„äºè¢«å–æ¶ˆ(ä½œåºŸ)çŠ¶æ€**ï¼Œä¸€æ—¦å¤„äºè¿™ä¸ªçŠ¶æ€ï¼Œè¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹åº”è¯¥ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚
  - `SIGNAL(-1)` - æ­¤çŠ¶æ€è¡¨ç¤ºï¼š**åç»§èŠ‚ç‚¹ä¼šè¢«æŒ‚èµ·**ï¼Œå› æ­¤åœ¨å½“å‰èŠ‚ç‚¹é‡Šæ”¾é”æˆ–è¢«å–æ¶ˆä¹‹åï¼Œå¿…é¡»å”¤é†’(`unparking`)å…¶åç»§ç»“ç‚¹ã€‚
  - `CONDITION(-2)` - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ **å¤„äºç­‰å¾…æ¡ä»¶çŠ¶æ€**ï¼Œä¸ä¼šè¢«å½“ä½œæ˜¯åŒæ­¥é˜Ÿåˆ—ä¸Šçš„èŠ‚ç‚¹ï¼Œç›´åˆ°è¢«å”¤é†’(`signal`)ï¼Œè®¾ç½®å…¶å€¼ä¸º 0ï¼Œå†é‡æ–°è¿›å…¥é˜»å¡çŠ¶æ€ã€‚
  - `PROPAGATE(-3)` - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šä¸‹ä¸€ä¸ª `acquireShared` åº”æ— æ¡ä»¶ä¼ æ’­ã€‚
  - 0 - éä»¥ä¸ŠçŠ¶æ€ã€‚

### ç‹¬å é”çš„è·å–ä¸é‡Šæ”¾

AQSç±»æ²¡æœ‰æä¾›å¯ç”¨çš„`tryAcquire`å’Œ`tryRelease`æ–¹æ³•, å®ƒä»¬éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°. å­ç±»åœ¨å®ç°`tryAcquire`å’Œ`tryRelease`æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹`state`çŠ¶æ€å€¼. å­ç±»è¿˜éœ€è¦å®šä¹‰åœ¨è°ƒç”¨`acquire`å’Œ`release`æ–¹æ³•æ—¶`state`çŠ¶æ€å€¼çš„å¢å‡ä»£è¡¨ä»€ä¹ˆå«ä¹‰.

#### è·å–ç‹¬å é”

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨`acquire(int arg)`æ–¹æ³•è·å–ç‹¬å èµ„æºæ—¶, ä¼šé¦–å…ˆä½¿ç”¨`tryAcquire`æ–¹æ³•å°è¯•è·å–èµ„æº, å…·ä½“æ˜¯è®¾ç½®çŠ¶æ€å˜é‡`state`çš„å€¼, æˆåŠŸåˆ™ç›´æ¥è¿”å›, å¤±è´¥åˆ™å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹ä¸º`Node.EXCLUSIVVE`çš„`Node`èŠ‚ç‚¹åæ’å…¥åˆ°`AQS`é˜»å¡é˜Ÿåˆ—çš„å°¾éƒ¨, å¹¶è°ƒç”¨`LockSupport.park(this)`æ–¹æ³•æŒ‚èµ·è‡ªå·±.

```java
public final void acquire(long arg) {
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

#### é‡Šæ”¾ç‹¬å é”

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨`release(int arg)`æ–¹æ³•æ—¶ä¼šå°è¯•ç”¨`tryRelease`æ“ä½œé‡Šæ”¾èµ„æº, è¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡`state`çš„å€¼, ç„¶åè°ƒç”¨`LockSupport.unpark(Thread)`æ–¹æ³•æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢è¢«é˜»å¡çš„ä¸€ä¸ªçº¿ç¨‹.è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨`tryAcquire`å°è¯•, çœ‹å½“å‰çŠ¶æ€å˜é‡`state`çš„å€¼æ˜¯å¦èƒ½æ»¡è¶³è‡ªå·±çš„éœ€è¦, æ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´», å¦åˆ™æ”¾å…¥AQSé˜Ÿåˆ—æŒ‚èµ·.

```java
public final boolean release(long arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```

#### è·å–å¯ä¸­æ–­çš„ç‹¬å é”

AQS ä¸­ä½¿ç”¨ `acquireInterruptibly(int arg)` æ–¹æ³•è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚

`acquireInterruptibly(int arg)` å®ç°æ–¹å¼**ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ `acquire`ï¼‰éå¸¸ç›¸ä¼¼**ï¼ŒåŒºåˆ«ä»…åœ¨äºå®ƒä¼š**é€šè¿‡ `Thread.interrupted` æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­**ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç«‹å³æŠ›å‡ºä¸­æ–­ï¼ˆ`InterruptedException`ï¼‰ã€‚

#### è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”

AQS ä¸­ä½¿ç”¨ `tryAcquireNanos(int arg)` æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…çš„ç‹¬å é”ã€‚

`doAcquireNanos` çš„å®ç°æ–¹å¼ **ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ `acquire`ï¼‰éå¸¸ç›¸ä¼¼**ï¼ŒåŒºåˆ«åœ¨äºå®ƒä¼šæ ¹æ®è¶…æ—¶æ—¶é—´å’Œå½“å‰æ—¶é—´è®¡ç®—å‡ºæˆªæ­¢æ—¶é—´ã€‚åœ¨è·å–é”çš„æµç¨‹ä¸­ï¼Œä¼šä¸æ–­åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œç›´æ¥è¿”å› falseï¼›å¦‚æœæ²¡è¶…æ—¶ï¼Œåˆ™ç”¨ `LockSupport.parkNanos` æ¥é˜»å¡å½“å‰çº¿ç¨‹

### å…±äº«é”çš„è·å–ä¸é‡Šæ”¾

AQSç±»æ²¡æœ‰æä¾›å¯ç”¨çš„`tryAcquireShared`å’Œ`tryReleaseShared`æ–¹æ³•, å®ƒä»¬éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°. å­ç±»åœ¨å®ç°`tryAcquire`å’Œ`tryRelease`æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹`state`çŠ¶æ€å€¼.

#### è·å–å…±äº«é”

å½“çº¿ç¨‹è°ƒç”¨`acquireShared(int arg)`è·å–å…±äº«èµ„æºæ—¶, ä¼šé¦–å…ˆä½¿ç”¨`tryAcquireShared`å°è¯•è·å–èµ„æº, å…·ä½“æ˜¯è®¾ç½®çŠ¶æ€å˜é‡`state`çš„å€¼, æˆåŠŸåˆ™ç›´æ¥è¿”å›, å¤±è´¥åˆ™å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹`Node.SHARED`çš„`Node`èŠ‚ç‚¹åæ’å…¥åˆ°AQSé˜»å¡é˜Ÿåˆ—å°¾éƒ¨, å¹¶è°ƒç”¨`LockSupport.park(this)`æ–¹æ³•æŒ‚èµ·è‡ªå·±.

```JAVA
public final void acquireShared(long arg) {
    if (tryAcquireShared(arg) < 0)
        doAcquireShared(arg);
}
```

#### é‡Šæ”¾å…±äº«é”

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨`releaseShared(int arg)`æ—¶ä¼šå°è¯•ä½¿ç”¨`tryReleaseShared`æ“ä½œé‡Šæ”¾èµ„æº, è¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡`state`çš„å€¼, ç„¶åä½¿ç”¨`LockSupport.unpark(thread)`æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢çš„ä¸€ä¸ªçº¿ç¨‹.è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨`tryReleaseShared`æŸ¥çœ‹å½“å‰çŠ¶æ€å˜é‡`state`çš„å€¼æ˜¯å¦æ»¡è¶³è‡ªå·±çš„éœ€è¦, æ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´»,  å¦åˆ™æ”¾å…¥AQSé˜Ÿåˆ—æŒ‚èµ·.

```java
public final boolean releaseShared(long arg) {
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}
```

#### è·å–å¯ä¸­æ–­çš„å…±äº«é”

AQS ä¸­ä½¿ç”¨ `acquireSharedInterruptibly(int arg)` æ–¹æ³•è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚

`acquireSharedInterruptibly` æ–¹æ³•ä¸ `acquireInterruptibly` å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚

#### è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”

AQS ä¸­ä½¿ç”¨ `tryAcquireSharedNanos(int arg)` æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”ã€‚

`tryAcquireSharedNanos` æ–¹æ³•ä¸ `tryAcquireNanos` å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚

# 7. å‚è€ƒèµ„æ–™

- <<Javaå¹¶å‘ç¼–ç¨‹ä¹‹ç¾>>

- [æ·±å…¥ç†è§£JAVAå¹¶å‘é”](https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99)

  