![image-20200607140323355](IPv4数据报首部格式.assets/image-20200607140323355.png)

### 版本字段

占4个比特，表示IP协议的版本，通信双方版本字段必须一致

### 首部长度

- 占四个比特，表示IP数据报首部的长度，该字段取值$\color{red}{以4字节为单位}$
- 最小十进制取值为5，表示IP数据报只有20字节固定部分
- 最大取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分

### 可选字段

- 长度从1个字节到10个字节不等。用来支持排错、测量及安全措施
- 增加了IP数据报的功能，同时也使IP数据报的首部长度成为可变的。增加了每一个路由器处理IP数据报的开销

### 填充字段

确保首部长度为4字节的整数倍，使用全0进行填充

### 区分服务字段

- 占8比特，用来获取更好的服务
- 利用该字段的不同数值可提供不同等级的服务质量
- 只有在使用区分服务时，该字段才起作用

### 总长度字段

- 占16比特，表示IP数据报的总长度（首部+数据载荷）
- 最大取值为十进制的65535，$\color{red}{以字节为单位}$

### 数据载荷长度计算

数据载荷长度 = 总长度($\color{red}{以字节为单位}$) - 首部长度字段($\color{red}{以4字节为单位}$)


### 标识字段

- 占16比特，属于同一个数据报的各分片的数据报应该具有相同的标识
- 每产生一个数据报，计数器值加一赋值给标识字段

### 标志字段

占3个比特，各比特含义如下：

- DF位：1表示不允许分片，0表示允许分片
- MF位：1表示后面还有分片，0表示这是最后一个分片
- 保留位：必须为0

### 片偏移字段

- 占13个比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位
- $\color{red}{以8个字节为单位，必须是整数}$

### IP数据报的分片

IPv4数据报在数据链路层封装成帧，帧的数据载荷长度受限于最大传输单元MTU（1500字节），当IPv4数据报总长度超过MTU时，无法封装，需要进行切片。

分片后的片偏移量必须是整数，所以分片时根据情况选取分片大小。

![image-20200607142528393](IPv4数据报首部格式.assets/image-20200607142528393.png)

![image-20200607142914003](IPv4数据报首部格式.assets/image-20200607142914003.png)

### 生存时间字段TTL

- $\color{red}{占8比特}$，以秒为单位，最大生存周期为255秒
- **以秒为单位**：路由器转发IP数据报时，将IP数据报该字段的值减去IP数据报在本路由上所消耗的时间，不为0就转发，否则就丢弃
- **以跳数为单位**：路由器转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃
- 保证IP数据报不会兜圈

### 协议字段

- 占8个比特，指明IPv4数据报部分是何种协议数据单元

常用协议和字段值如下：

- ICMP——1
- IGMP——2
- TCP——6
- UDP——17
- IPv6——41
- OSPF——89

### 首部检验和字段

- 占16比特，检测首部在传输过程中是否出现差错
- IP数据报每经过一个路由器，都要检查首部检验和，耗时操作。所以IPv6不计算首部检验和，从而更快转发IP数据报

### 源IP地址和目的IP地址字段

各占32比特，用来填写发送IP数据报的源主机的IP地址和接收IP数据报的目的主机的IP地址