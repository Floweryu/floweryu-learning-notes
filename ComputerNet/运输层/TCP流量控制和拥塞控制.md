## 流量控制

让发送方发送的数据不要太快，要让接收方来得及接收

利用滑动窗口机制来实现对发送方的流量控制：

- TCP接收方利用自己接收窗口的大小来限制发送方发送窗口的大小
- TCP发送方收到接收方的零窗口通知后，启动持续计时器。持续计时器超时后，向接收方发送零窗口探测报文。

![image-20200607202448599](TCP流量控制和拥塞控制.assets/image-20200607202448599.png)

![image-20200607202636391](TCP流量控制和拥塞控制.assets/image-20200607202636391.png)

TCP规定，即使接收窗口为0，也必须接受零窗口探测报文段，确认报文段， 以及携带有紧急数据的报文段。

## 习题

![image-20200607203314704](TCP流量控制和拥塞控制.assets/image-20200607203314704.png)

## 拥塞控制

在某段时间，对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏，这种情况叫做拥塞

发送方维护一个拥塞窗口的变量，其值取决于网络的拥塞程度，并且动态变化

- 拥塞窗口cwnd维护原则：只要网络没有出现拥塞，拥塞窗口就再增大一些；但只要网络出现拥塞，拥塞窗口就减少一些。
- 判断出现网络拥塞的证据：没有按时收到应当到达的确认报文（即发生超时重传）

发送方将拥塞窗口作为发送窗口swnd，swnd=cwnd

### 慢开始

维护一个**慢开始门限**ssthresh状态变量：

- 当cwnd < ssthresh时，使用慢开始算法
- 当cwnd > ssthresh时，停止使用慢开始算法而改变拥塞避免算法
- 当cwnd = ssthresh时，即可使用慢开始算法，也可使用拥塞避免算法

慢开始算法，**拥塞窗口指数增大。**

### 拥塞避免

当拥塞窗口cwnd的值达到慢开始门限值ssthresh时，执行拥塞避免算法，拥塞窗口的指$\color{red}{按线性加一方式增大}$

当网络出现重传（即重传计时器超时）：

- **将ssthresh值更新为发生拥塞时cwnd值的一半**
- **将cwnd值减小为1，并重新开始执行慢开始算法**

慢开始和拥塞避免示意图：

![image-20200607205105126](TCP流量控制和拥塞控制.assets/image-20200607205105126.png)

### 快重传

采用快重传的原因：

​		有时，个别报文段会在网络中丢失，但实际上网络并未发生拥塞。这将导致发送方超时重传，并误认为网络发生了拥塞；发送方把拥塞窗口cwnd又设置为最小值1，并错误的启动慢开始算法，因而降低了传输效率。

采用快重传算法可以让发送方尽早知道发生了个别报文段的丢失。

使发送方尽快进行重传，而不是等超时重传计时器超时再重传

- 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认
- 即使收到失序的报文段也要立即发出对已收到的报文段的重复确认
- 发送方一旦$\color{red}{收到3个连续的重复确认}$，就将相应的报文段立即重传，而不是等该报文段超时重传计时器超时再重传
- 对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（进而降低拥塞窗口cwnd为1）

![image-20200607210002175](TCP流量控制和拥塞控制.assets/image-20200607210002175.png)

### 快恢复

发送方收到3个重复确认，就知道只是丢失了个别报文段，执行快恢复算法：

- 发送方将$\color{red}{慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口一半}$，开始执行拥塞避免算法

也可以把快恢复开始时的拥塞窗口cwnd值再增大一些，即等于新的ssthresh + 3

- 既然发送方收到3个重复的确认，就表明有3个数据报已经离开了网络
- 这三个数据报不再消耗网络资源而是停留在接收方的接受缓存中
- 可见在网络中不是堆积了报文段而是减少了3个报文段。因此可以适当把拥塞窗口扩大些

### 算法示意图

![image-20200607210438552](TCP流量控制和拥塞控制.assets/image-20200607210438552.png)

### 题目

![image-20200607211003189](TCP流量控制和拥塞控制.assets/image-20200607211003189.png)