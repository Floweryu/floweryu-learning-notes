## 基本概念

- 不可靠传输服务：仅仅丢弃有误码的帧，其他什么也不做

- 可靠传输服务：发送端发送什么，接收端就收到什么

一般情况下，有线链路的误码率比较低，为了减小开销	，并不要求数据链路层向上提供可靠传输服务。

而无线链路易受干扰，误码率比较高，因此要求数据链路层必须向上层提供可靠传输服务。

## 停止等待协议SW

发送方每发送一个数据分组后，就停止发送下一个数据分组，并将该分组存储起来，等待来自接收方的确认分组和否认分组。若收到确认分组，则继续发送下一个数据分组；若收到否认分组，则重发之前发送的那个数据分组。

![image-20200605152336785](可靠传输.assets/image-20200605152336785.png)

### 超时重传

如果接收方接收不到数据分组，就不会发送ACK或NAK数据。如果不采取措施，发送方就会一直处于等待接受ACK或NAK的状态。

![image-20200605152620883](可靠传输.assets/image-20200605152620883.png)

为解决该问题，在发送方发送完数据分组时，启动一个超时计时器。超过超时计时器设置的重传时间，则重传原来的分组。

重传时间设为**从发送方到接收方的平均往返时间**。

### 给数据分组编号

![image-20200605152824741](可靠传输.assets/image-20200605152824741.png)

### 给确认分组编号

![image-20200605153044422](可靠传输.assets/image-20200605153044422.png)

数据链路层一般不会出现ACK分组迟到的情况，因此在数据链路层可以不用编号。

![image-20200605153252193](可靠传输.assets/image-20200605153252193.png)

### 信道利用率

![image-20200605153427265](可靠传输.assets/image-20200605153427265.png)

## 回退N帧协议

### 累积确认

接收方不一定对收到的数据分组逐个发送确认，而是可以在收到几个数据分组后（由具体实现决定），对按序到达的最后一个数据分组发送确认。

**ACKn表示序号为n及以前的所有数据分组都已正确接收。**累积确认序号之间的都已经发送。

**好处：**即使确认分组丢失，发送方也不必重传。

**缺点**：不能向发送方及时的反应接收方已经接收的正确分组的信息。

发送方收到重复的确认，就说明之前发送的数据分组出现了差错。

![image-20200605155339761](可靠传输.assets/image-20200605155339761.png)

## 选择重传协议

视频链接：https://www.bilibili.com/video/BV1c4411d7jb?p=27

接收窗口尺寸不应该等于1，而是大于1。以便接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组，等到所缺分组收齐后再一并送交上层。

为了使双方仅重传出现差错的分组，接收方不能再采用累积确认，需要对每个正确接收到的数据分组进行逐一确认。

### 发送方

发送方窗口尺寸必须满足：$1 < W_t <= 2^{n-1}$

其中，n 是构成分组序号的比特数量。

- 若$W_t = 1$：与停止-等待协议相同
- 若$W_t > 2^{n-1}$：造成接收方无法分辨新、旧数据分组的问题
- 发送方可在未收到接收方确认分组情况下，将序号落在发送窗口内的多个数据分组全部发送出去。
- 发送方只有按序收到对已发送数据分组的确认时，发送窗口才能向前相应滑动；若收到未按序到达的确认分组时，对其进行记录，以防止其相应数据分组的超时重发，但发送窗口不能向前滑动。

### 接收方

接收方的接收窗口尺寸$W_r$必须满足：$1 < W_r <= W_t$

- 若$W_r = 1$，与回退N帧协议相同
- 若$W_r > W_t$：无意义

- 接收方可接收未按序到达但没有误码并且序号落在接收窗口内的数据分组；
	- 为了使发送双方仅重传出现差错的分组，接收方不能再采用累积确认，而需要对每个正确接收到的数据分组进行逐一确认
- 接收方只有在按序接收数据分组后，接收窗口才能向前相应滑动。

## 习题

![image-20200611212450128](可靠传输.assets/image-20200611212450128.png)